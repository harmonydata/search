"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7199],{57199:(e,t,a)=>{a.r(t),a.d(t,{default:()=>V});var l=a(95155),i=a(12115),s=a(35761),n=a(55295),r=a(68998),o=a(9552),d=a(9561),u=a(70152),c=a(22282),h=a(47821),g=a(19579),m=a(6327),v=a(72107),f=a(5565),x=a(10979),p=a(44315);function y(e){let{results:t,resourceTypeFilter:a,onSelectResult:i,selectedResultId:s,onFindSimilar:n,collapsed:o=!1}=e,u=a&&a.length>0?t.filter(e=>{var t,l;return(null===(t=e.extra_data)||void 0===t?void 0:t.resource_type)&&a.map(e=>e.trim().toLowerCase()).includes(null===(l=e.extra_data)||void 0===l?void 0:l.resource_type.trim().toLowerCase())}):t;console.log("SearchResults debug:",{resourceTypeFilter:a,originalResults:t,filteredResults:u});let c=e=>{i&&i(e)};return u.length?(0,l.jsx)(r.default,{children:(0,l.jsx)(x.A,{spacing:1.5,sx:{mb:4},children:u.map((e,t)=>{var a,i;let r=s===(null===(a=e.extra_data)||void 0===a?void 0:a.uuid);return(0,l.jsx)(p.A,{result:e,isSelected:r,onClick:()=>c(e),onFindSimilar:n},(null===(i=e.extra_data)||void 0===i?void 0:i.uuid)||"result-".concat(t))})})}):(0,l.jsx)(r.default,{sx:{textAlign:"center",py:8},children:(0,l.jsx)(d.A,{color:"text.secondary",children:"No results found. Try adjusting your search criteria."})})}var _=a(14030),b=a(69110),j=a(42649),w=a(10683),S=a(63612),A=a(54615),C=a(73179),k=a(20687),D=a(76046),E=a(1234),I=a(64517),R=a(9450),F=a(64364),L=a(22783),P=a(25012),T=a(15325),z=a(66917),W=a(79201),M=a(99489),q=a(15617),O=a(63219),U=a(89026);function B(e){let{useSearch2:t,onEndpointChange:a,hybridWeight:s,onHybridWeightChange:n,maxDistance:o,onMaxDistanceChange:u}=e,[h,g]=(0,i.useState)(null),m=(0,i.useRef)(null),[v,f]=(0,i.useState)(null),[x,p]=(0,i.useState)(!0),y=!!h;return(0,i.useEffect)(()=>{(async()=>{try{let e=await (0,j.Pn)();f(e)}catch(e){console.error("Failed to fetch version info:",e),f({harmony_discovery_version:"Unknown"})}finally{p(!1)}})()},[]),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(r.default,{sx:{display:"flex",alignItems:"center",gap:2},children:[(0,l.jsx)(c.A,{ref:m,variant:"contained",color:"secondary",onClick:()=>{g(m.current)},sx:{minWidth:0,width:40,height:40,borderRadius:"50%",p:0},children:y?(0,l.jsx)(U.A,{}):(0,l.jsx)(O.A,{})}),(0,l.jsx)(d.A,{sx:{color:"#191B22",fontWeight:500,whiteSpace:"nowrap"},children:"Advanced Search"})]}),(0,l.jsx)(z.Ay,{open:y,anchorEl:h,onClose:()=>{g(null)},anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},sx:{mt:1},children:(0,l.jsxs)(r.default,{sx:{p:3,minWidth:280},children:[(0,l.jsx)(d.A,{variant:"h6",gutterBottom:!0,children:"Search Configuration"}),(0,l.jsx)(r.default,{sx:{mb:3},children:(0,l.jsx)(W.A,{control:(0,l.jsx)(M.A,{checked:t,onChange:e=>{a(e.target.checked)},color:"primary"}),label:(0,l.jsxs)(r.default,{children:[(0,l.jsx)(d.A,{variant:"body2",fontWeight:500,children:"Search Version"}),(0,l.jsx)(d.A,{variant:"caption",color:"text.secondary",children:t?"Previous Version":x?"Loading...":(null==v?void 0:v.harmony_discovery_version)||"Current Version"})]})})}),(0,l.jsxs)(r.default,{sx:{mb:2},children:[(0,l.jsxs)(d.A,{variant:"body2",fontWeight:500,gutterBottom:!0,children:["Hybrid Weight: ",s.toFixed(2)]}),(0,l.jsx)(d.A,{variant:"caption",color:"text.secondary",gutterBottom:!0,display:"block",children:"Controls the balance between semantic and keyword search"}),(0,l.jsx)(r.default,{sx:{px:2,mt:2},children:(0,l.jsx)(q.Ay,{value:s,onChange:(e,t)=>{n(t)},min:0,max:1,step:.01,valueLabelDisplay:"auto",valueLabelFormat:e=>e.toFixed(2),marks:[{value:0,label:"Keyword"},{value:.5,label:"Balanced"},{value:1,label:"Semantic"}]})})]}),(0,l.jsxs)(r.default,{sx:{mb:2},children:[(0,l.jsxs)(d.A,{variant:"body2",fontWeight:500,gutterBottom:!0,children:["Max Distance: ",o.toFixed(2)]}),(0,l.jsx)(d.A,{variant:"caption",color:"text.secondary",gutterBottom:!0,display:"block",children:"Controls the maximum vector distance for semantic search results"}),(0,l.jsx)(r.default,{sx:{px:2,mt:2},children:(0,l.jsx)(q.Ay,{value:o,onChange:(e,t)=>{u(t)},min:0,max:1,step:.01,valueLabelDisplay:"auto",valueLabelFormat:e=>e.toFixed(2),marks:[{value:0,label:"0"},{value:.4,label:"0.4"},{value:1,label:"1"}]})})]}),(0,l.jsx)(r.default,{sx:{mt:3,p:2,bgcolor:"grey.50",borderRadius:1},children:(0,l.jsxs)(d.A,{variant:"caption",color:"text.secondary",children:[(0,l.jsx)("strong",{children:"Tip:"})," Hybrid weight is automatically adjusted based on query length. Short queries favor keyword search (lower values), while longer queries favor semantic search (higher values)."]})})]})})]})}var N=a(3485),H=a(71900);function K(){var e,t,a,x,p,z,W;let M=(0,s.A)(),q=(0,n.A)(M.breakpoints.down("lg")),{searchSettings:O,updateSearchSettings:U}=(0,S.S)(),[K,V]=(0,i.useState)(O.query),[J,Y]=(0,i.useState)(O.query),[Q,X]=(0,i.useState)([]),[Z,$]=(0,i.useState)([]),[G,ee]=(0,i.useState)(O.selectedFilters),[et,ea]=(0,i.useState)(O.selectedCategory),[el,ei]=(0,i.useState)(!1),[es,en]=(0,i.useState)(!0),[er,eo]=(0,i.useState)(!1),[ed,eu]=(0,i.useState)(0),[ec,eh]=(0,i.useState)(1),[eg,em]=(0,i.useState)(!1),[ev,ef]=(0,i.useState)(null),[ex,ep]=(0,i.useState)(!1),[ey,e_]=(0,i.useState)(!1),[eb,ej]=(0,i.useState)(!1),[ew,eS]=(0,i.useState)(!1),[eA,eC]=(0,i.useState)(null),[ek,eD]=(0,i.useState)(O.useSearch2),[eE,eI]=(0,i.useState)(O.hybridWeight),[eR,eF]=(0,i.useState)(O.hybridWeight),[eL,eP]=(0,i.useState)(O.maxDistance),[eT,ez]=(0,i.useState)(O.maxDistance),[eW,eM]=(0,i.useState)(null),[eq,eO]=(0,i.useState)(null),[eU,eB]=(0,i.useState)([]),[eN,eH]=(0,i.useState)(void 0),[eK,eV]=(0,i.useState)([]),[eJ,eY]=(0,i.useState)(!1),[eQ,eX]=(0,i.useState)(!1),[eZ,e$]=(0,i.useState)(!1),[eG,e0]=(0,i.useState)(!1),{currentUser:e1}=(0,w.A)();(0,i.useEffect)(()=>{U({query:K,selectedFilters:G,selectedCategory:et,useSearch2:ek,hybridWeight:eE,maxDistance:eL})},[K,G,et,ek,eE,eL,U]),(0,i.useEffect)(()=>{e$(!1)},[K,G,ek,eE,eL,et]),(0,i.useEffect)(()=>{let e=O.query&&""!==O.query.trim(),t=Object.keys(O.selectedFilters).length>0;!eG&&(e||t)&&(e0(!0),tD(O.query||"",1))},[O,eG,tD]),(0,i.useEffect)(()=>{e0(!1)},[]);let e2=(0,D.useSearchParams)(),e5=e2.get("resource_type"),e4=e2.get("like"),e6=e2.get("query"),e3=e2.getAll("topics"),e9=e2.getAll("instruments"),e8=e2.getAll("study_design");(0,i.useEffect)(()=>{if(e6||e3.length>0||e9.length>0||e8.length>0){let e={};e3.length>0&&(e.keywords=e3),e9.length>0&&(e.instruments=e9),e8.length>0&&(e.study_design=e8),e5&&(e.resource_type=[e5]),U({query:e6||"",selectedFilters:e,selectedCategory:null,resourceType:e5,similarUid:e4})}},[]);let e7=(0,D.useRouter)();(0,i.useEffect)(()=>{let e=!1;if(e6&&(V(e6),Y(e6),e=!0),e3&&e3.length>0&&(!G.keywords||G.keywords.join(",")!==e3.join(","))&&(ee(e=>({...e,keywords:e3})),e=!0),e9&&e9.length>0&&(!G.instruments||G.instruments.join(",")!==e9.join(","))&&(ee(e=>({...e,instruments:e9})),e=!0),e8&&e8.length>0&&(!G.study_design||G.study_design.join(",")!==e8.join(","))&&(ee(e=>({...e,study_design:e8})),e=!0),e){let e=new URL(window.location.href);e.searchParams.delete("query"),e.searchParams.delete("topics"),e.searchParams.delete("instruments"),e.searchParams.delete("study_design");let t=e.pathname.replace("/search","");console.log("Navigating to:",t+e.search),e7.replace(t+e.search)}},[e6,e3,e9,e8]);let te=(0,i.useMemo)(()=>e5?[e5]:[],[e5]),tt=(0,i.useRef)(J),ta=(0,i.useRef)(JSON.stringify(G)),tl=(0,i.useRef)(ek),ti=(0,i.useRef)(eR),ts=(0,i.useRef)(eT),tn=(0,i.useRef)(eU);(0,i.useRef)(!1);let tr=(0,i.useRef)([]),to=(0,i.useRef)(void 0),td=(0,i.useCallback)(e=>{if(!e||""===e.trim()||"*"===e)return .5;let t=e.trim();return eK.some(e=>t.toLowerCase()===e.toLowerCase())?0:.5},[eK]),tu=(0,i.useCallback)(e=>{eD(e)},[]),tc=(0,i.useCallback)(e=>{eI(e)},[]),th=(0,i.useCallback)(e=>{eP(e)},[]);(0,i.useEffect)(()=>{let e=td(J);eI(e),eF(e)},[J,td]),(0,i.useEffect)(()=>{let e=setTimeout(()=>{Y(K)},500);return()=>{clearTimeout(e)}},[K]),(0,i.useEffect)(()=>{let e=setTimeout(()=>{eF(eE)},300);return()=>{clearTimeout(e)}},[eE]),(0,i.useEffect)(()=>{let e=setTimeout(()=>{ez(eL)},300);return()=>{clearTimeout(e)}},[eL]),(0,i.useEffect)(()=>{(async()=>{if(!eJ)try{let e=await (0,j.Qf)();eV(e),eY(!0)}catch(e){console.error("Failed to fetch keyword phrases:",e),eY(!0)}})()},[eJ]);let tg=(0,i.useCallback)(()=>{var e,t;window.__debugState={currentPage:ec,totalHits:ed,resultsPerPage:50,searchQuery:K,debouncedSearchQuery:J,selectedFilters:G,filters:Z,results:Q,selectedResult:ev,apiOffline:ew,topLevelIdsSeen:eU},console.log("Current state stored in window.__debugState"),console.log("Current state:",{pagination:{currentPage:ec,totalHits:ed},searchQuery:K,debouncedSearchQuery:J,selectedFilters:G,filterCount:Z.length,resultCount:Q.length,selectedResult:ev?{id:null===(e=ev.extra_data)||void 0===e?void 0:e.uuid,title:null===(t=ev.dataset_schema)||void 0===t?void 0:t.name}:null,apiOffline:ew})},[ec,ed,50,K,J,G,Z,Q,ev,ew,eU]),tm=(0,i.useCallback)(e=>{ef(e),q&&ep(!0)},[q]),tv=(0,i.useCallback)(e=>{console.log("Selected result:",e),tm(e)},[tm]),tf=(0,i.useCallback)(()=>{ep(!1)},[]),tx=(0,i.useCallback)(()=>{!q&&ev&&ej(!0)},[q,ev]),tp=(0,i.useCallback)(()=>{q||ej(e=>!e)},[q]);(0,i.useCallback)(()=>{em(e=>!e),tg()},[tg]),(0,i.useEffect)(()=>{{let e=e=>e.target!==window||(console.log("Preserving console log"),e.stopPropagation(),!1);return window.addEventListener("beforeunload",e,!0),()=>{window.removeEventListener("beforeunload",e,!0)}}},[]),(0,i.useEffect)(()=>{(async function(){try{console.log("Fetching initial aggregations..."),ei(!0),eS(!1);let e=new Promise((e,t)=>{setTimeout(()=>t(Error("API request timed out")),6e4)}),t=await Promise.race([(0,j.Dd)(),e]),a=tF(t);$(a),console.log("Initial aggregations set:",a.length,"filters"),ei(!1)}catch(e){console.error("Failed to fetch initial aggregations:",e),eS(!0),ei(!1)}})()},[]),(0,i.useEffect)(()=>{Q.length>0&&!ev?ef(Q[0]):Q.length>0&&ev?Q.some(e=>{var t,a;return(null===(t=e.extra_data)||void 0===t?void 0:t.uuid)===(null===(a=ev.extra_data)||void 0===a?void 0:a.uuid)})||ef(Q[0]):0===Q.length&&ef(null)},[Q,ev]),(0,i.useEffect)(()=>{e_(!1)},[ev]);let ty=(0,i.useCallback)(e=>{var t,a,l,i,s,n,r,o,d,u,c,h,g,m,v,f,x,p,y,_,b,j,w,S,A,C,k,D,E,I,R,F,L,P,T,z,W,M,q,O,U,B,N,H;let K,V,J;let Y=null===(a=e.extra_data)||void 0===a?void 0:null===(t=a.resource_type)||void 0===t?void 0:t.includes("variable"),Q=Array.isArray(e.ancestors)&&e.ancestors.length>0,X=Y&&Q&&(null===(l=e.ancestors)||void 0===l?void 0:l[0])||e,Z=(null===(i=X.dataset_schema)||void 0===i?void 0:i.name)||"Untitled Dataset",$=(null===(s=X.dataset_schema)||void 0===s?void 0:s.description)||"",G=(null===(n=X.dataset_schema)||void 0===n?void 0:n.image)||X.image||void 0;(null===(d=X.dataset_schema)||void 0===d?void 0:null===(o=d.publisher)||void 0===o?void 0:null===(r=o[0])||void 0===r?void 0:r.name)&&(V={name:X.dataset_schema.publisher[0].name,url:null===(M=X.dataset_schema.publisher[0])||void 0===M?void 0:M.url,logo:null===(q=X.dataset_schema.publisher[0])||void 0===q?void 0:q.logo});let ee=null===(c=X.dataset_schema)||void 0===c?void 0:null===(u=c.includedInDataCatalog)||void 0===u?void 0:u.some(e=>{var t,a;return(null===(t=e.name)||void 0===t?void 0:t.includes("Mental Health"))||(null===(a=e.name)||void 0===a?void 0:a.includes("CMHM"))}),et=null===(h=X.topics)||void 0===h?void 0:h.some(e=>e.toLowerCase().includes("mental health")||e.toLowerCase().includes("psychiatry")||e.toLowerCase().includes("psychology")),ea=e=>{if(!e.includes(" ")||/[,.;]/.test(e))return!1;let t=e.split(" ").map(e=>e.trim()).filter(e=>e.length>0);return t.filter(e=>e.length<=8||e.toUpperCase()===e||/[A-Z]{2,}/.test(e)).length/t.length>.6};if((null===(g=X.dataset_schema)||void 0===g?void 0:g.funder)&&Array.isArray(X.dataset_schema.funder)&&X.dataset_schema.funder.length>0)J=X.dataset_schema.funder.map(e=>({name:e.name||"Funding Organization",url:null==e?void 0:e.url,logo:null==e?void 0:e.logo}));else if(X.funders||(null===(m=X.extra_data)||void 0===m?void 0:m.funders)){let e=X.funders||(null===(O=X.extra_data)||void 0===O?void 0:O.funders);Array.isArray(e)?J=e.map(e=>"string"==typeof e?{name:e}:"object"==typeof e&&null!==e?{name:e.name||"Funding Organization",url:e.url,logo:e.logo}:{name:String(e)}):"string"==typeof e&&e.trim()&&(J=(ee||et||ea(e))&&e.includes(" ")?e.split(" ").map(e=>e.trim()).filter(e=>e.length>0).map(e=>({name:e})):e.includes(" ")&&!/[,.;]/.test(e)?e.split(" ").filter(e=>e.trim().length>0).map(e=>({name:e})):[{name:e}])}if(!J||0===J.length||ee||et){let e=[X.cmhm_funders,null===(U=X.extra_data)||void 0===U?void 0:U.cmhm_funders,X.funding_bodies,null===(B=X.extra_data)||void 0===B?void 0:B.funding_bodies,X.funding,null===(N=X.extra_data)||void 0===N?void 0:N.funding,X.funder,null===(H=X.extra_data)||void 0===H?void 0:H.funder].find(e=>null!=e);if(e){let t=[];if("string"==typeof e&&e.trim()?t=ea(e)?e.split(" ").map(e=>e.trim()).filter(e=>e.length>0).map(e=>({name:e})):[{name:e}]:Array.isArray(e)&&(t=e.map(e=>"string"==typeof e?{name:e}:{name:e.name||String(e),url:e.url,logo:e.logo})),J&&J.length>0){let e=new Set(J.map(e=>e.name));J=[...J,...t.filter(t=>!e.has(t.name))]}else J=t}}(!J||1===J.length)&&(null==J?void 0:null===(v=J[0])||void 0===v?void 0:v.name)&&ea(J[0].name)&&(J=J[0].name.split(" ").map(e=>e.trim()).filter(e=>e.length>0).map(e=>({name:e})));let el=X.geographic_coverage||(null===(x=X.extra_data)||void 0===x?void 0:null===(f=x.country_codes)||void 0===f?void 0:f.join(", "))||(null===(p=X.country_codes)||void 0===p?void 0:p.join(", "))||void 0,ei=(null===(y=X.dataset_schema)||void 0===y?void 0:y.temporalCoverage)||X.start_year&&"".concat(X.start_year).concat(X.end_year?"..".concat(X.end_year):""),es=(null===(_=X.sample_size)||void 0===_?void 0:_.toString())||(null===(j=X.dataset_schema)||void 0===j?void 0:null===(b=j.size)||void 0===b?void 0:b.toString())||void 0,en=(null===(w=X.extra_data)||void 0===w?void 0:w.age_lower)||X.age_lower,er=(null===(S=X.extra_data)||void 0===S?void 0:S.age_upper)||X.age_upper,eo=void 0!==en&&void 0!==er?"".concat(en," - ").concat(er," years"):void 0!==en?"".concat(en,"+ years"):void 0!==er?"0 - ".concat(er," years"):void 0,ed=(null===(A=X.extra_data)||void 0===A?void 0:A.study_design)||X.study_design||[],eu=(null===(C=X.extra_data)||void 0===C?void 0:C.resource_type)||(null===(k=X.dataset_schema)||void 0===k?void 0:k["@type"])||void 0,ec=((null===(D=X.dataset_schema)||void 0===D?void 0:D.keywords)||X.topics||[]).filter(e=>"string"==typeof e&&!e.includes("<a title=")&&!e.startsWith("<")),eh=(null===(E=X.extra_data)||void 0===E?void 0:E.instruments)||[],eg=X.variables_which_matched||[],em=(null===(I=X.dataset_schema)||void 0===I?void 0:I.variableMeasured)||[],ev=new Set;if((null===(R=X.dataset_schema)||void 0===R?void 0:R.includedInDataCatalog)&&X.dataset_schema.includedInDataCatalog.length>0){let e=X.dataset_schema.url||[];K=X.dataset_schema.includedInDataCatalog.map(t=>{let a=t.url;if(Array.isArray(e)&&a)try{let t=new URL(a).hostname,l=e.find(e=>{try{return new URL(e).hostname===t}catch(e){return!1}});l&&(a=l)}catch(e){console.warn("Failed to parse catalog URL",e)}return a&&ev.add(a),{name:t.name||"Data Catalog",url:a||void 0,logo:t.image}})}let ef=[];if((null===(F=X.dataset_schema)||void 0===F?void 0:F.identifier)&&Array.isArray(X.dataset_schema.identifier)){let e=X.dataset_schema.identifier.filter(e=>!!(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("10.")&&e.includes("/"))).map(e=>e.startsWith("10.")&&e.includes("/")?"https://doi.org/".concat(e):e);ef=[...ef,...e.filter(e=>!ev.has(e))]}if((null===(L=X.dataset_schema)||void 0===L?void 0:L.url)&&Array.isArray(X.dataset_schema.url)){let e=X.dataset_schema.url.filter(e=>!ev.has(e));ef=[...ef,...e]}[X.url,X.original_source_url,(null===(P=X.doi)||void 0===P?void 0:P.startsWith("10."))?"https://doi.org/".concat(X.doi):null].filter(Boolean).forEach(e=>{!e||ev.has(e)||ef.includes(e)||ef.push(e)}),ef=Array.from(new Set(ef));let ex=(null===(T=X.extra_data)||void 0===T?void 0:T.ai_summary)||null;return{title:Z,description:$,image:G,uuid:null===(z=X.extra_data)||void 0===z?void 0:z.uuid,slug:null===(W=X.extra_data)||void 0===W?void 0:W.slug,publisher:V,funders:J,geographicCoverage:el,temporalCoverage:ei,sampleSize:es,ageCoverage:eo,studyDesign:ed,resourceType:eu,topics:ec,instruments:eh,dataCatalogs:K,matchedVariables:eg,allVariables:em,additionalLinks:ef,child_datasets:X.child_datasets||[],aiSummary:ex}},[]),t_=async()=>{if(e1&&K.trim()&&!eQ){eX(!0),e$(!1);try{let e={query:K,filters:G,useSearch2:ek,hybridWeight:eE,maxDistance:eL,selectedCategory:et,resultCount:Q.length,uid:e1.uid,created:(0,A.O5)()};console.log("Saving search:",e,C.db),await (0,A.gS)((0,A.rJ)(C.db,"saved_searches"),e),e$(!0)}catch(e){console.error("Error saving search:",e)}finally{eX(!1)}}},[tb,tj]=(0,i.useState)(null),[tw,tS]=(0,i.useState)(null),[tA,tC]=(0,i.useState)(!1);(0,i.useEffect)(()=>{if(!ev){tj(null),tS(null),tC(!1);return}tj(ty(ev)),tC(!0),tS({originalSearchResult:ev,lookupData:null})},[ev,ty]),(0,i.useEffect)(()=>{let e=!1;async function t(){if(ev)try{var t;let a=td(K),l=await (0,j.w3)((null===(t=ev.extra_data)||void 0===t?void 0:t.uuid)||"",K,a,eT);!l.variables_which_matched&&ev.variables_which_matched&&(l.variables_which_matched=ev.variables_which_matched),!l.child_datasets&&ev.datasets_which_matched&&(l.child_datasets=ev.datasets_which_matched);let i=ty(l);e||(tj(i),tS({originalSearchResult:ev,lookupData:l}),tC(!1))}catch(t){console.error("Failed to load enhanced study detail:",t),e||tC(!1)}}return ev&&t(),()=>{e=!0}},[ev,K,eT,td]),(0,i.useEffect)(()=>{(async function(){if(e4)try{var e,t;ei(!0);let a=await (0,j.w3)(e4,void 0,void 0,eT);eC(a);let l=(null===(e=a.dataset_schema)||void 0===e?void 0:e.description)||(null===(t=a.extra_data)||void 0===t?void 0:t.description);if(!l)throw Error("No description available for similar search");V(l),Y(l);let i=td(l),s=await (0,j.Hu)(l,{},1,50,ek,i,void 0,void 0,void 0,eT);X(s.results||[]),eu(s.num_hits||0)}catch(e){console.error("Failed to load similar studies:",e),eS(!0)}finally{ei(!1)}})()},[e4,50,ek,eR]),(0,i.useEffect)(()=>{var e,t;let a=J!==tt.current||JSON.stringify(G)!==ta.current||ek!==tl.current||eR!==ti.current||eT!==ts.current,l=e4&&((null==eA?void 0:null===(e=eA.dataset_schema)||void 0===e?void 0:e.description)||(null==eA?void 0:null===(t=eA.extra_data)||void 0===t?void 0:t.description))||J;a&&(console.log("\uD83D\uDD0D Search parameters changed, clearing results and resetting to page 1"),X([]),eB([]),tr.current=[],eH(void 0),to.current=void 0,1!==ec&&eh(1),tD(l,1).finally(()=>{tt.current=J,ta.current=JSON.stringify(G),tl.current=ek,ti.current=eR,ts.current=eT,tn.current=eU}))},[J,G,e4,eA,ek,eR,eT]),(0,i.useEffect)(()=>{if(ec>1){var e,t;console.log("\uD83D\uDCC4 Page changed to:",ec,"- loading more results"),tD(e4&&((null==eA?void 0:null===(e=eA.dataset_schema)||void 0===e?void 0:e.description)||(null==eA?void 0:null===(t=eA.extra_data)||void 0===t?void 0:t.description))||J,ec)}},[ec]);let tk=(0,i.useCallback)(async()=>{if(console.log("\uD83D\uDD04 loadMore called:",{loadingMore:er,hasMoreResults:es,currentPage:ec,resultsLength:Q.length}),er||!es){console.log("\uD83D\uDD04 loadMore early return:",{loadingMore:er,hasMoreResults:es});return}let e=ec+1;console.log("\uD83D\uDD04 loadMore proceeding to page:",e),eh(e)},[er,es,ec]);async function tD(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:J,t=arguments.length>1?arguments[1]:void 0,a=void 0!==t?t:ec;1===a?ei(!0):eo(!0),eS(!1);let l=Date.now();1===a&&(en(!0),eo(!1));try{var i,s;let t;let n={...G};e5&&(n.resource_type=[e5]),Object.keys(n).forEach(e=>{Array.isArray(n[e])&&0===n[e].length&&delete n[e]});let r="search-".concat(Date.now());console.group("\uD83D\uDD0D Search Request: ".concat(r)),console.log("Search query:",e||"(empty)"),console.log("Filters:",n),console.log("Page:",a),console.log("Results per page:",50),console.log("Use Search2:",ek),console.log("Similar UID (will be excluded):",e4||"None"),console.log("Top Level IDs Seen:",a>1?eU:"First page");let o=new Promise((e,t)=>{setTimeout(()=>t(Error("API request timed out")),6e4)}),d=Date.now();a>1?t=tr.current:e4&&(t=[e4],console.log("Excluding original study from similar search:",e4)),console.log("Detailed pagination info:",{pageToUse:a,topLevelIdsSeenLength:eU.length,topLevelIdsSeenSample:eU.slice(0,5),currentTopLevelIdsRefLength:tr.current.length,currentTopLevelIdsRefSample:tr.current.slice(0,5),nextPageOffset:to.current,idsToExclude:t||[],willPassIds:a>1&&!ek,willPassOffset:a>1&&void 0!==to.current,willUsePost:a>1&&!ek&&((null==t?void 0:t.length)||0)>0,useSearch2:ek});let u=td(e),c=await Promise.race([(0,j.Hu)(e,n,a,50,ek,u,t,a>1?to.current:void 0,void 0,eT),o]),h=Date.now()-d;eO(h),console.log("Response received:",{requestId:r,numHits:c.num_hits,resultCount:(null===(i=c.results)||void 0===i?void 0:i.length)||0,apiTime:"".concat(h,"ms"),results:null===(s=c.results)||void 0===s?void 0:s.map(e=>{var t,a,l,i;return{id:null===(t=e.extra_data)||void 0===t?void 0:t.uuid,title:null===(a=e.dataset_schema)||void 0===a?void 0:a.name,type:(null===(l=e.extra_data)||void 0===l?void 0:l.resource_type)||(null===(i=e.dataset_schema)||void 0===i?void 0:i["@type"]),similarity:e.cosine_similarity}}),timestamp:new Date().toISOString()}),console.groupEnd();let g=c.results||[];if(c.top_level_ids_seen_so_far?(console.log("Received top_level_ids_seen_so_far:",{count:c.top_level_ids_seen_so_far.length,sample:c.top_level_ids_seen_so_far.slice(0,5),previousCount:eU.length}),eB(c.top_level_ids_seen_so_far),tr.current=c.top_level_ids_seen_so_far):console.log("No top_level_ids_seen_so_far in response"),void 0!==c.next_page_offset?(console.log("Received next_page_offset:",{offset:c.next_page_offset,previousOffset:to.current}),eH(c.next_page_offset),to.current=c.next_page_offset):console.log("No next_page_offset in response (using calculated offset)"),1===a){if(X(g),eu(c.num_hits||0),ek)en(50===g.length&&g.length<(c.num_hits||0));else{let e=g.length>0;en(e),(!e||g.length<50)&&eu(Math.max(c.num_hits||0,g.length)),g.length>0&&g.length<50&&g.length<20&&(console.log("\uD83D\uDD04 Auto-loading next page from first page - insufficient results:",{gotResults:g.length,requestedResults:50,minThreshold:20,nextPage:2}),setTimeout(()=>{!er&&es&&eh(2)},100))}}else if(X(e=>{if(!ek&&g.length>0){let t;t=1===a?g.length:e.length+g.length,g.length<50&&t<20&&(console.log("\uD83D\uDD04 Auto-loading next page - insufficient results:",{gotResults:g.length,requestedResults:50,currentTotal:t,minThreshold:20,nextPage:a+1}),setTimeout(()=>{!er&&es&&eh(a+1)},100))}return[...e,...g]}),ek)en(50===g.length);else{let e=g.length>0;en(e),e||eu(Math.max(ed,Q.length+g.filter(e=>!Q.some(t=>{var a,l;return(null===(a=t.extra_data)||void 0===a?void 0:a.uuid)===(null===(l=e.extra_data)||void 0===l?void 0:l.uuid)})).length))}let m=Date.now();eM(m-l)}catch(e){console.error("Search failed:",e),eS(!0),eM(null),eO(null)}finally{ei(!1),eo(!1)}}let tE=(e,t)=>{ee(a=>({...a,[e]:t}))},tI=e=>{let t=(null==G?void 0:G.keywords)||[];if(!t.includes(e)){let a=[...t,e];ee(e=>({...e,keywords:a})),tE("keywords",a)}},tR=e=>{let t=(null==G?void 0:G.instruments)||[];if(!t.includes(e)){let a=[...t,e];ee(e=>({...e,instruments:a})),tE("instruments",a)}},tF=e=>{let t=[],a=["sample_size","age_lower","age_upper","start_year","end_year","duration_years","num_variables","num_sweeps"],l=1/0,i=-1/0;if(Object.entries(e).forEach(e=>{let[s,n]=e;if("age_lower"===s||"age_upper"===s||"age_min"===s||"age_max"===s){let e=n.statistics||{},t=e.minimum;"number"==typeof t&&isFinite(t)||(t=e.min);let a=e.maximum;"number"==typeof a&&isFinite(a)||(a=e.max),"number"==typeof t&&isFinite(t)&&(l=Math.min(l,t)),"number"==typeof a&&isFinite(a)&&(i=Math.max(i,a));return}if(a.includes(s)){let e,a;let l=n.statistics||{};"number"==typeof l.minimum&&isFinite(l.minimum)?e=l.minimum:"number"==typeof l.min&&isFinite(l.min)?e=l.min:(console.warn("Missing valid min value for ".concat(s,", using default")),e="sample_size"===s?0:"start_year"===s||"end_year"===s?1900:0),"number"==typeof l.maximum&&isFinite(l.maximum)?a=l.maximum:"number"==typeof l.max&&isFinite(l.max)?a=l.max:(console.warn("Missing valid max value for ".concat(s,", using default")),a="sample_size"===s?1e5:"start_year"===s||"end_year"===s?2024:"duration_years"===s?100:"num_variables"===s?1e4:"num_sweeps"===s?50:100),a<=e&&(a=e+1);let i=Array.from({length:101},(t,l)=>String(e+l/100*(a-e)));t.push({id:s,label:s.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),type:"range",options:i})}else{let e=n.buckets||[];e.length>0&&t.push({id:s,label:s.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),type:"multiselect",options:e.map(e=>e.key||"")})}}),isFinite(l)&&isFinite(i)&&l<=i){i<=l&&(i=l+1);let e=Array.from({length:101},(e,t)=>String(l+t/100*(i-l)));t.push({id:"age_range",label:"Age Range",type:"range",options:e})}else{console.warn("Missing valid age range data, using defaults");let e=Array.from({length:101},(e,t)=>String(0+t/100*100));t.push({id:"age_range",label:"Age Range",type:"range",options:e})}return t},tL=(0,i.useCallback)(async e=>{var t,a,l,i,s,n,r;let o=null===(t=e.extra_data)||void 0===t?void 0:t.uuid;if(!o)return;let d=(null===(a=e.dataset_schema)||void 0===a?void 0:a.name)||(null===(l=e.extra_data)||void 0===l?void 0:l.name)||"Unnamed Study";V("LIKE:".concat(d," (").concat(o,")"));let u=(null===(i=e.dataset_schema)||void 0===i?void 0:i.description)||(null===(s=e.extra_data)||void 0===s?void 0:s.description);if(!u)try{let e=await (0,j.w3)(o,void 0,void 0,eT);u=(null===(n=e.dataset_schema)||void 0===n?void 0:n.description)||(null===(r=e.extra_data)||void 0===r?void 0:r.description)}catch(e){console.error("Failed to fetch description for LIKE search",e);return}u&&(Y(u),tP(u))},[]),tP=async e=>{ei(!0),eS(!1);try{let t;let a={...G};e5&&(a.resource_type=[e5]),Object.keys(a).forEach(e=>{Array.isArray(a[e])&&0===a[e].length&&delete a[e]});let l=e,i=e.match(/^LIKE:(.*?)\s*\(([^)]+)\)$/);i&&(t=i[2],l="LIKE:".concat(t));let s=td(l),n=await (0,j.Hu)(l,a,ec,50,ek,s,t?[t]:ec>1?tr.current:void 0,ec>1?to.current:void 0,void 0,eT);X(n.results||[]),eu(n.num_hits||0)}catch(e){eS(!0)}finally{ei(!1)}};return(0,l.jsx)(r.default,{sx:{height:"100vh",overflow:"hidden",display:"flex",flexDirection:"column"},children:(0,l.jsxs)(o.A,{maxWidth:"xl",sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",py:{xs:2,sm:3,md:4}},children:[(0,l.jsx)(r.default,{sx:{display:"flex",alignItems:"center",gap:3,mb:{xs:2,sm:3,md:4}},children:e4?(0,l.jsxs)(r.default,{sx:{display:"flex",alignItems:"center",gap:3,width:"100%",p:3,bgcolor:"background.paper",borderRadius:2,boxShadow:1},children:[(0,l.jsx)(r.default,{sx:{width:120,height:120,display:"flex",alignItems:"center",justifyContent:"center",color:"grey.500"},children:(null==eA?void 0:null===(e=eA.dataset_schema)||void 0===e?void 0:e.image)?(0,l.jsx)(f.default,{src:(null==eA?void 0:eA.dataset_schema).image,alt:(null==eA?void 0:null===(t=eA.dataset_schema)||void 0===t?void 0:t.name)||"Study",width:100,height:100,style:{objectFit:"contain"},unoptimized:!0}):(e=>{var t,a;let i=(null==e?void 0:null===(t=e.extra_data)||void 0===t?void 0:t.resource_type)||(null==e?void 0:null===(a=e.dataset_schema)||void 0===a?void 0:a["@type"]);return(null==i?void 0:i.includes("dataset"))?(0,l.jsx)(E.A,{size:48}):(null==i?void 0:i.includes("variable"))?(0,l.jsx)(I.A,{size:48}):(null==i?void 0:i.includes("study"))?(0,l.jsx)(R.A,{size:48}):(0,l.jsx)(F.A,{size:48})})(eA)}),(0,l.jsxs)(r.default,{children:[(0,l.jsx)(d.A,{variant:"h4",gutterBottom:!0,children:(null==eA?void 0:null===(a=eA.dataset_schema)||void 0===a?void 0:a.name)||(null==eA?void 0:null===(x=eA.extra_data)||void 0===x?void 0:x.name)||"Unnamed Study"}),(0,l.jsx)(d.A,{variant:"subtitle1",color:"text.secondary",children:"Similar Studies"})]})]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(u.A,{fullWidth:!0,placeholder:"What are you searching for?",value:K,onChange:e=>{V(e.target.value)},InputProps:{endAdornment:(0,l.jsxs)(r.default,{sx:{mr:1,ml:-.5,display:"flex",alignItems:"center",gap:1},children:[K!==J&&(0,l.jsx)(d.A,{variant:"caption",color:"text.secondary",sx:{fontSize:{xs:"0.6rem",sm:"0.7rem"}},children:"Typing..."}),(0,l.jsx)(f.default,{src:(0,N.xC)()+"icons/discover.svg",alt:"Search",width:20,height:20})]}),sx:{height:48,"& .MuiOutlinedInput-root":{borderRadius:24},"& .MuiOutlinedInput-notchedOutline":{borderColor:"grey.200"}}},sx:{"& .MuiOutlinedInput-root":{borderRadius:24}}}),(0,l.jsx)(r.default,{sx:{display:"flex",alignItems:"center",gap:2},children:(0,l.jsx)(B,{useSearch2:ek,onEndpointChange:tu,hybridWeight:eE,onHybridWeightChange:tc,maxDistance:eL,onMaxDistanceChange:th})})]})}),(0,l.jsx)(_.A,{filtersData:Z,onSelectionChange:tE,selectedFilters:G}),!el&&!ew&&(Q.length>0||ed>0)&&(0,l.jsxs)(r.default,{sx:{mb:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,l.jsxs)(d.A,{variant:"body2",color:"text.secondary",children:[es?Q.length>ed?"".concat(Q.length," results loaded (").concat(ed,"+ estimated)"):ed>0?"".concat(Q.length," of ~").concat(ed," results loaded"):"".concat(Q.length," results loaded"):"".concat(Q.length," results found"),eq&&" (API: ".concat(eq,"ms"),eW&&eq&&", Total: ".concat(eW,"ms)")]}),e1&&Q.length>0&&(0,l.jsx)(c.A,{variant:"outlined",size:"small",startIcon:eZ?(0,l.jsx)(k.A,{size:16,fill:"currentColor"}):(0,l.jsx)(k.A,{size:16}),onClick:t_,disabled:eQ||!K.trim(),sx:{ml:2,color:eZ?"success.main":"inherit",borderColor:eZ?"success.main":"inherit"},title:"Save this search",children:eQ?"Saving...":eZ?"Saved!":"Save Search"})]}),(0,l.jsxs)(r.default,{sx:{display:q?"block":"flex",width:"100%",flex:1,minHeight:0,overflow:"visible",position:"relative"},children:[(0,l.jsx)(r.default,{sx:{width:q?"100%":"50%",minWidth:q?"100%":"300px",overflowX:"hidden",display:"flex",flexDirection:"column",height:"100%",position:"relative"},children:el?(0,l.jsx)(d.A,{children:"Loading search results..."}):ew?(0,l.jsxs)(r.default,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",py:8,px:4,height:"100%"},children:[(0,l.jsx)(v.A,{sx:{fontSize:{xs:48,sm:64},color:"text.secondary",mb:2}}),(0,l.jsx)(d.A,{variant:"h5",color:"text.secondary",gutterBottom:!0,children:"The discovery API is currently offline"}),(0,l.jsx)(d.A,{color:"text.secondary",children:"Please try again soon. We apologize for the inconvenience."}),(0,l.jsx)(c.A,{variant:"contained",sx:{mt:4},onClick:()=>{eS(!1),tD()},children:"Retry Connection"})]}):(0,l.jsx)(l.Fragment,{children:(0,l.jsx)(r.default,{sx:{flex:1,overflowY:"auto",minHeight:0,display:"flex",flexDirection:"column"},id:"search-results-container",children:(0,l.jsx)(H.A,{dataLength:Q.length,next:tk,hasMore:es,loader:!J&&(!G||Object.values(G).every(e=>0===e.length))?(0,l.jsxs)(r.default,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",py:6,textAlign:"center"},children:[(0,l.jsx)(d.A,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"Enter a search term or select some filters to begin"}),(0,l.jsx)(d.A,{variant:"body2",color:"text.secondary",children:"Use the search bar above or apply filters to discover studies"})]}):(0,l.jsx)(r.default,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:3},children:(0,l.jsx)(L.A,{size:24,className:"animate-spin",style:{color:"#1976d2"}})}),scrollableTarget:"search-results-container",endMessage:(0,l.jsx)(d.A,{children:"No more results to load."}),children:(0,l.jsx)(y,{results:Q,resourceTypeFilter:te,onSelectResult:tv,selectedResultId:null==ev?void 0:null===(p=ev.extra_data)||void 0===p?void 0:p.uuid,onFindSimilar:tL})})})})}),!q&&(Q.length>0||ed>0)&&(0,l.jsxs)(r.default,{sx:{position:"absolute",top:0,right:0,width:eb?"calc(100% - 130px)":"50%",height:"100%",bgcolor:"background.paper",borderLeft:"1px solid",borderColor:"grey.200",display:"flex",flexDirection:"column",overflow:"visible",transition:"width 0.3s ease-in-out",cursor:ev?"pointer":"default",zIndex:eb?2:1,boxShadow:eb?"-4px 0 8px rgba(0, 0, 0, 0.1)":"none"},onClick:tx,children:[(0,l.jsx)(r.default,{sx:{position:"absolute",top:-16,left:-16,zIndex:1e3},children:(0,l.jsx)(h.A,{onClick:e=>{e.stopPropagation(),tp()},sx:{bgcolor:"primary.main",color:"white","&:hover":{bgcolor:"primary.dark"},boxShadow:2,width:30,height:30},children:eb?(0,l.jsx)(T.A,{size:20}):(0,l.jsx)(P.A,{size:20})})}),ew?(0,l.jsxs)(r.default,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",p:4,height:"100%"},children:[(0,l.jsx)(v.A,{sx:{fontSize:{xs:36,sm:48},color:"text.secondary",mb:2}}),(0,l.jsx)(d.A,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"API Offline"}),(0,l.jsx)(d.A,{variant:"body2",color:"text.secondary",children:"Study details unavailable"})]}):tb?(0,l.jsx)(r.default,{sx:{height:"100%",overflowY:"auto",minHeight:0},children:(0,l.jsx)(b.A,{study:tb,isDrawerView:!1,onTopicClick:tI,onInstrumentClick:tR,debugData:tw,originalSearchResult:null==tw?void 0:tw.lookupData,isLoadingEnhancedData:tA})}):(0,l.jsx)(r.default,{sx:{display:"flex",height:"100%",alignItems:"center",justifyContent:"center",p:2},children:(0,l.jsx)(d.A,{color:"text.secondary",children:"Select a dataset to view details"})})]})]}),(0,l.jsxs)(g.Ay,{anchor:"right",open:q&&ex,onClose:tf,sx:{"& .MuiDrawer-paper":{width:{xs:"100%",sm:"80%",md:"60%"},maxWidth:"600px",p:0,overflow:"hidden",display:"flex",flexDirection:"column"}},children:[(0,l.jsxs)(r.default,{sx:{position:"sticky",top:0,zIndex:10,bgcolor:"background.paper",borderBottom:"1px solid",borderColor:"grey.200",p:1},children:[(0,l.jsx)(h.A,{onClick:tf,sx:{position:"absolute",top:8,right:8},children:(0,l.jsx)(m.A,{})}),(0,l.jsxs)(r.default,{sx:{py:1,pl:1,pr:6,display:"flex",alignItems:"center",gap:2},children:[(0,l.jsx)(d.A,{variant:"h6",sx:{flex:1},children:ev&&(null===(z=ev.dataset_schema)||void 0===z?void 0:z.name)||"Study Details"}),ev&&(ev.dataset_schema&&ev.dataset_schema.image||ev.image)&&!ey&&(0,l.jsx)(r.default,{sx:{width:50,height:50,position:"relative",borderRadius:"4px",overflow:"hidden",flexShrink:0},children:(0,l.jsx)(f.default,{src:ev.dataset_schema&&ev.dataset_schema.image||ev.image,alt:(null===(W=ev.dataset_schema)||void 0===W?void 0:W.name)||"Study image",fill:!0,style:{objectFit:"contain"},onError:()=>e_(!0),unoptimized:!0})})]})]}),(0,l.jsx)(r.default,{sx:{p:0,overflow:"hidden",display:"flex",flexDirection:"column",flex:1},children:tb?(0,l.jsx)(b.A,{study:tb,isDrawerView:!0,onTopicClick:tI,onInstrumentClick:tR,debugData:tw,originalSearchResult:null==tw?void 0:tw.lookupData,isLoadingEnhancedData:tA}):(0,l.jsx)(r.default,{sx:{display:"flex",height:"100%",alignItems:"center",justifyContent:"center",p:2},children:(0,l.jsx)(d.A,{color:"text.secondary",children:"Select a dataset to view details"})})})]})]})})}function V(){return(0,l.jsx)(i.Suspense,{fallback:(0,l.jsx)(r.default,{sx:{p:4},children:(0,l.jsx)(d.A,{children:"Loading..."})}),children:(0,l.jsx)(K,{})})}},63612:(e,t,a)=>{a.d(t,{S:()=>o,SearchProvider:()=>r});var l=a(95155),i=a(12115);let s={query:"",selectedFilters:{},useSearch2:!1,hybridWeight:.5,maxDistance:.4,selectedCategory:null,resourceType:null,similarUid:null},n=(0,i.createContext)(void 0);function r(e){let{children:t}=e,[a,r]=(0,i.useState)(s),o=(0,i.useCallback)(e=>{r(t=>({...t,...e}))},[]),d=(0,i.useCallback)(()=>{r(s)},[]),u=(0,i.useCallback)(e=>{r({...s,query:e.query,selectedFilters:e.filters||{}})},[]);return(0,l.jsx)(n.Provider,{value:{searchSettings:a,updateSearchSettings:o,resetSearchSettings:d,loadSearchFromSaved:u},children:t})}function o(){let e=(0,i.useContext)(n);if(void 0===e)throw Error("useSearch must be used within a SearchProvider");return e}}}]);