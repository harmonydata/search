"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1522],{31522:(e,t,i)=>{i.r(t),i.d(t,{default:()=>es});var l=i(95155),r=i(12115),a=i(35761),s=i(55295),n=i(68998),o=i(9552),d=i(9561),c=i(70152),u=i(22282),h=i(47821),x=i(19579),m=i(6327),g=i(72107),f=i(5565),y=i(10979),p=i(98245);function v(e){let{results:t,resourceTypeFilter:i,onSelectResult:r,selectedResultId:a,onFindSimilar:s,collapsed:o=!1,hasActiveSearch:c=!1}=e,u=i&&i.length>0?t.filter(e=>{var t,l;return(null===(t=e.extra_data)||void 0===t?void 0:t.resource_type)&&i.map(e=>e.trim().toLowerCase()).includes(null===(l=e.extra_data)||void 0===l?void 0:l.resource_type.trim().toLowerCase())}):t,h=e=>{r&&r(e)};return u.length?(0,l.jsx)(n.default,{children:(0,l.jsx)(y.A,{spacing:1.5,sx:{mb:4},children:u.map((e,t)=>{var i,r;let n=a===(null===(i=e.extra_data)||void 0===i?void 0:i.uuid);return(0,l.jsx)(p.A,{result:e,isSelected:n,onClick:()=>h(e),onFindSimilar:s},(null===(r=e.extra_data)||void 0===r?void 0:r.uuid)||"result-".concat(t))})})}):(0,l.jsx)(n.default,{sx:{textAlign:"center",py:8,maxWidth:600,mx:"auto"},children:c?(0,l.jsxs)(n.default,{children:[(0,l.jsx)(d.A,{variant:"h5",color:"text.primary",gutterBottom:!0,children:"No results found"}),(0,l.jsx)(d.A,{variant:"body1",color:"text.secondary",gutterBottom:!0,children:"We couldn't find any studies matching your search criteria."}),(0,l.jsx)(d.A,{variant:"body2",color:"text.secondary",children:"Try adjusting your search terms, removing some filters, or broadening your criteria to find more results."})]}):(0,l.jsxs)(n.default,{sx:{textAlign:"center",py:8,maxWidth:600,mx:"auto"},children:[(0,l.jsx)(d.A,{variant:"h5",color:"text.primary",gutterBottom:!0,children:"No Results"}),(0,l.jsx)(d.A,{variant:"body1",color:"text.secondary",children:"Enter a search term or apply filters to find studies."})]})})}var b=i(14030),j=i(77626),_=i(72926),S=i(70424),A=i(66917),w=i(48139),C=i(30762);function k(e){let{onSubmitFeedback:t}=e,[i,a]=(0,r.useState)(null),[s,o]=(0,r.useState)(null),[x,g]=(0,r.useState)(""),[f,p]=(0,r.useState)(!1),v=()=>{a(null),o(null),g("")},b=async()=>{if(s){p(!0);try{await (null==t?void 0:t(s,x)),v()}catch(e){console.error("Error submitting feedback:",e)}finally{p(!1)}}};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(_.A,{title:"Give feedback",placement:"left",children:(0,l.jsx)(S.A,{color:"primary",size:"small",onClick:e=>{a(e.currentTarget)},sx:{position:"fixed",bottom:0,right:0,zIndex:1e3,boxShadow:3,borderRadius:"4px 0 0 0"},children:(0,l.jsx)(C.A,{})})}),(0,l.jsx)(A.Ay,{open:!!i,anchorEl:i,onClose:v,anchorOrigin:{vertical:"center",horizontal:"left"},transformOrigin:{vertical:"center",horizontal:"right"},sx:{"& .MuiPopover-paper":{borderRadius:2,boxShadow:3}},children:(0,l.jsxs)(n.default,{sx:{p:3,minWidth:300},children:[(0,l.jsxs)(n.default,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[(0,l.jsx)(d.A,{variant:"h6",component:"h2",children:"Share your feedback"}),(0,l.jsx)(h.A,{size:"small",onClick:v,children:(0,l.jsx)(m.A,{})})]}),(0,l.jsxs)(y.A,{spacing:2,children:[(0,l.jsxs)(n.default,{children:[(0,l.jsx)(d.A,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"How would you rate your experience?"}),(0,l.jsx)(w.A,{name:"feedback-rating",value:s,onChange:(e,t)=>{o(t)},size:"large"})]}),(0,l.jsx)(c.A,{multiline:!0,rows:3,placeholder:"Tell us what you think... (optional)",value:x,onChange:e=>g(e.target.value),variant:"outlined",size:"small",fullWidth:!0}),(0,l.jsxs)(n.default,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:[(0,l.jsx)(u.A,{size:"small",onClick:v,children:"Cancel"}),(0,l.jsx)(u.A,{variant:"contained",size:"small",onClick:b,disabled:!s||f,children:f?"Submitting...":"Submit"})]})]})]})})]})}var D=i(66656);let F=["Why are more children obese now?","What factors influence mental health in teenagers?","How does income affect educational outcomes?"];function R(e){let{title:t="Discover Research Studies",subtitle:i="Search or filter to begin",onExampleClick:r}=e;return(0,l.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",width:"100%",minHeight:200,p:4,borderRadius:4,background:"linear-gradient(135deg, #27EDB9 0%, #2E5FFF 100%)",boxShadow:"0 8px 32px rgba(46, 95, 255, 0.15)",mb:4},children:[(0,l.jsx)(d.A,{variant:"h4",sx:{color:"white",fontWeight:600,textAlign:"center",mb:2,textShadow:"0 2px 4px rgba(0, 0, 0, 0.1)"},children:t}),(0,l.jsx)(d.A,{variant:"h6",sx:{color:"white",fontWeight:400,textAlign:"center",opacity:.9,textShadow:"0 1px 2px rgba(0, 0, 0, 0.1)",mb:3},children:i}),(0,l.jsxs)(n.default,{sx:{mt:2,textAlign:"center",maxWidth:600},children:[(0,l.jsx)(d.A,{variant:"body1",sx:{color:"white",fontWeight:400,textAlign:"center",opacity:.95,textShadow:"0 1px 2px rgba(0, 0, 0, 0.1)",mb:2},children:"Harmony understands the meaning of your query so you can search for things like:"}),(0,l.jsx)(n.default,{sx:{display:"flex",flexDirection:"column",gap:1,alignItems:"center"},children:F.map((e,t)=>(0,l.jsx)(D.A,{onClick:t=>{t.preventDefault(),r&&r(e)},sx:{color:"white",textDecoration:"underline",textDecorationColor:"rgba(255, 255, 255, 0.6)",textUnderlineOffset:4,cursor:"pointer",fontWeight:500,"&:hover":{textDecorationColor:"white",opacity:1},transition:"all 0.2s ease"},children:e},t))})]})]})}var W=i(42649);let I=null,E=async()=>{if(I)return I;console.log("\uD83D\uDD0D Loading Firebase modules dynamically for feedback");let[{collection:e,addDoc:t,serverTimestamp:l},{db:r}]=await Promise.all([Promise.resolve().then(i.bind(i,54615)),Promise.resolve().then(i.bind(i,73179))]);return I={collection:e,addDoc:t,serverTimestamp:l,db:r}},z=async(e,t)=>{try{let{db:i,collection:l,addDoc:r,serverTimestamp:a}=await E(),s={uid:"anon",rating:e,comment:t||"",created:a(),source:"discoverynext"},n=await r(l(i,"ratings"),s);return console.log("Feedback submitted with ID: ",n.id),n}catch(e){throw console.error("Error submitting feedback:",e),e}};var T=i(17146),P=i(63612),O=i(54615),U=i(73179),M=i(20687),q=i(76046),L=i(1234),B=i(64517),N=i(9450),H=i(41983),Q=i(22783),V=i(25012),K=i(15325),J=i(63219),Y=i(89026),G=i(79201),X=i(99489);function $(){let{searchSettings:e,updateSearchSettings:t}=(0,P.S)(),[i,a]=(0,r.useState)(null),[s,o]=(0,r.useState)(!0);return(0,r.useEffect)(()=>{(async()=>{try{let e=await (0,W.Pn)();a(e)}catch(e){console.error("Failed to fetch version info:",e),a({harmony_discovery_version:"Unknown"})}finally{o(!1)}})()},[]),(0,l.jsx)(n.default,{sx:{mb:3},children:(0,l.jsx)(G.A,{control:(0,l.jsx)(X.A,{checked:e.useSearch2,onChange:e=>{t({useSearch2:e.target.checked})},color:"primary"}),label:(0,l.jsxs)(n.default,{children:[(0,l.jsx)(d.A,{variant:"body2",fontWeight:500,children:"Search Version"}),(0,l.jsx)(d.A,{variant:"caption",color:"text.secondary",children:e.useSearch2?"Previous Version":s?"Loading...":(null==i?void 0:i.harmony_discovery_version)||"Current Version"})]})})})}var Z=i(96588);function ee(){let{searchSettings:e,updateSearchSettings:t}=(0,P.S)(),[i,a]=(0,r.useState)(e.hybridWeight),s=(0,r.useRef)(null);return(0,r.useEffect)(()=>{a(e.hybridWeight)},[e.hybridWeight]),(0,r.useEffect)(()=>()=>{s.current&&clearTimeout(s.current)},[]),(0,l.jsxs)(n.default,{sx:{mb:2},children:[(0,l.jsxs)(d.A,{variant:"body2",fontWeight:500,gutterBottom:!0,children:["Hybrid Weight: ",i.toFixed(2)]}),(0,l.jsx)(d.A,{variant:"caption",color:"text.secondary",gutterBottom:!0,display:"block",children:"Controls the balance between semantic and keyword search"}),(0,l.jsx)(n.default,{sx:{px:2,mt:2},children:(0,l.jsx)(Z.Ay,{value:i,onChange:(e,i)=>{a(i),s.current&&clearTimeout(s.current),s.current=setTimeout(()=>{t({hybridWeight:i})},300)},min:0,max:1,step:.01,valueLabelDisplay:"auto",valueLabelFormat:e=>e.toFixed(2),marks:[{value:0,label:"Keyword"},{value:.5,label:"Balanced"},{value:1,label:"Semantic"}]})})]})}function et(){let{searchSettings:e,updateSearchSettings:t}=(0,P.S)(),[i,a]=(0,r.useState)(e.maxDistance),s=(0,r.useRef)(null);return(0,r.useEffect)(()=>{a(e.maxDistance)},[e.maxDistance]),(0,r.useEffect)(()=>()=>{s.current&&clearTimeout(s.current)},[]),(0,l.jsxs)(n.default,{sx:{mb:2},children:[(0,l.jsxs)(d.A,{variant:"body2",fontWeight:500,gutterBottom:!0,children:["Max Distance: ",i.toFixed(2)]}),(0,l.jsx)(d.A,{variant:"caption",color:"text.secondary",gutterBottom:!0,display:"block",children:"Controls the maximum vector distance for semantic search results"}),(0,l.jsx)(n.default,{sx:{px:2,mt:2},children:(0,l.jsx)(Z.Ay,{value:i,onChange:(e,i)=>{a(i),s.current&&clearTimeout(s.current),s.current=setTimeout(()=>{t({maxDistance:i})},300)},min:0,max:1,step:.01,valueLabelDisplay:"auto",valueLabelFormat:e=>e.toFixed(2),marks:[{value:0,label:"0"},{value:.4,label:"0.4"},{value:1,label:"1"}]})})]})}function ei(){let[e,t]=(0,r.useState)(null),i=(0,r.useRef)(null),a=!!e;return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(n.default,{sx:{display:"flex",alignItems:"center",gap:2},children:[(0,l.jsx)(u.A,{ref:i,variant:"contained",color:"secondary",onClick:()=>{t(i.current)},sx:{minWidth:0,width:40,height:40,borderRadius:"50%",p:0},children:a?(0,l.jsx)(Y.A,{}):(0,l.jsx)(J.A,{})}),(0,l.jsx)(d.A,{sx:{color:"#191B22",fontWeight:500,whiteSpace:"nowrap"},children:"Advanced Search"})]}),(0,l.jsx)(A.Ay,{open:a,anchorEl:e,onClose:()=>{t(null)},anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},sx:{mt:1},children:(0,l.jsxs)(n.default,{sx:{p:3,minWidth:280},children:[(0,l.jsx)(d.A,{variant:"h6",gutterBottom:!0,children:"Search Configuration"}),(0,l.jsx)($,{}),(0,l.jsx)(ee,{}),(0,l.jsx)(et,{}),(0,l.jsx)(n.default,{sx:{mt:3,p:2,bgcolor:"grey.50",borderRadius:1},children:(0,l.jsxs)(d.A,{variant:"caption",color:"text.secondary",children:[(0,l.jsx)("strong",{children:"Tip:"})," Adjust the hybrid weight to balance between keyword search (lower values) and semantic search (higher values). The default value of 0.5 provides a balanced approach."]})})]})})]})}var el=i(3485),er=i(71900);function ea(){var e,t,i,y,p,_,S;let A=(0,a.A)(),w=(0,s.A)(A.breakpoints.down("sm")),C=(0,s.A)(A.breakpoints.down("lg")),{searchSettings:D,updateQuery:F,updateSearchSettings:I}=(0,P.S)(),[E,J]=(0,r.useState)([]),[Y,G]=(0,r.useState)([]),[X,$]=(0,r.useState)(!1),[Z,ee]=(0,r.useState)(!0),[et,ea]=(0,r.useState)(!1),[es,en]=(0,r.useState)(0),[eo,ed]=(0,r.useState)(1),[ec,eu]=(0,r.useState)(null),[eh,ex]=(0,r.useState)(!1),[em,eg]=(0,r.useState)(!1),[ef,ey]=(0,r.useState)(!1),[ep,ev]=(0,r.useState)(!1),[eb,ej]=(0,r.useState)(null),[e_,eS]=(0,r.useState)(null),[eA,ew]=(0,r.useState)(null),[eC,ek]=(0,r.useState)([]),[eD,eF]=(0,r.useState)(void 0),[eR,eW]=(0,r.useState)(!1),[eI,eE]=(0,r.useState)(!1),{currentUser:ez}=(0,T.A)(),eT=(0,q.useSearchParams)(),eP=eT.get("resource_type"),eO=eT.get("like");(0,q.useRouter)();let eU=(0,r.useRef)(eT.get("query")),eM=(0,r.useRef)(eT.getAll("topics")),eq=(0,r.useRef)(eT.getAll("instruments")),eL=(0,r.useRef)(eT.getAll("study_design")),eB=eU.current,eN=eM.current,eH=eq.current,eQ=eL.current,eV=(0,r.useMemo)(()=>eP?[eP]:[],[eP]),eK=(0,r.useRef)(D.debouncedQuery),eJ=(0,r.useRef)(JSON.stringify(D.selectedFilters)),eY=(0,r.useRef)(D.useSearch2),eG=(0,r.useRef)(D.hybridWeight),eX=(0,r.useRef)(D.maxDistance),e$=(0,r.useRef)(eC);(0,r.useRef)(!1);let eZ=(0,r.useRef)([]),e0=(0,r.useRef)(void 0),e1=(0,r.useCallback)(e=>{eu(e),w?ex(!0):ey(!0)},[w]),e2=(0,r.useCallback)(e=>{console.log("Selected result:",e),e1(e)},[e1]),e5=(0,r.useCallback)(()=>{ex(!1)},[]),e4=(0,r.useCallback)(()=>{!w&&ec&&ey(!0)},[w,ec]),e6=(0,r.useCallback)(()=>{w||ey(e=>!e)},[w]);(0,r.useEffect)(()=>{(async function(){try{console.log("Fetching initial aggregations..."),$(!0),ev(!1);let e=new Promise((e,t)=>{setTimeout(()=>t(Error("API request timed out")),6e4)}),t=await Promise.race([(0,W.Dd)(),e]),i=tl(t);G(i),console.log("Initial aggregations set:",i.length,"filters"),$(!1)}catch(e){console.error("Failed to fetch initial aggregations:",e),ev(!0),$(!1)}})()},[]),(0,r.useEffect)(()=>{E.length>0&&!ec?eu(E[0]):E.length>0&&ec?E.some(e=>{var t,i;return(null===(t=e.extra_data)||void 0===t?void 0:t.uuid)===(null===(i=ec.extra_data)||void 0===i?void 0:i.uuid)})||eu(E[0]):0===E.length&&eu(null)},[E,ec]),(0,r.useEffect)(()=>{eg(!1)},[ec]);let e3=(0,r.useCallback)(e=>{var t,i,l;let r=null===(i=e.extra_data)||void 0===i?void 0:null===(t=i.resource_type)||void 0===t?void 0:t.includes("variable"),a=Array.isArray(e.ancestors)&&e.ancestors.length>0;return r&&a&&(null===(l=e.ancestors)||void 0===l?void 0:l[0])||e},[]),e9=async()=>{if(ez&&D.query.trim()&&!eR){eW(!0),eE(!1);try{let e={query:D.query,filters:D.selectedFilters,useSearch2:D.useSearch2,hybridWeight:D.hybridWeight,maxDistance:D.maxDistance,selectedCategory:D.selectedCategory,resultCount:E.length,uid:ez.uid,created:(0,O.serverTimestamp)()};console.log("Saving search:",e,U.db),await (0,O.addDoc)((0,O.collection)(U.db,"saved_searches"),e),eE(!0)}catch(e){console.error("Error saving search:",e)}finally{eW(!1)}}},[e8,e7]=(0,r.useState)(null);(0,r.useEffect)(()=>{if(!ec){e7(null);return}e7(e3(ec))},[ec,e3]),(0,r.useEffect)(()=>{(async function(){if(D.similarUid)try{var e,t;$(!0);let i=await (0,W.w3)(D.similarUid,void 0,void 0,D.maxDistance);ej(i);let l=(null===(e=i.dataset_schema)||void 0===e?void 0:e.description)||(null===(t=i.extra_data)||void 0===t?void 0:t.description);if(!l)throw Error("No description available for similar search");F(l);let r=await (0,W.Hu)(l,{},1,50,D.useSearch2,D.hybridWeight,void 0,void 0,void 0,D.maxDistance);J(r.results||[]),en(r.num_hits||0)}catch(e){console.error("Failed to load similar studies:",e),ev(!0)}finally{$(!1)}})()},[D.similarUid,50,D.useSearch2,D.hybridWeight,F]),(0,r.useEffect)(()=>{var e,t;let i=D.debouncedQuery!==eK.current||JSON.stringify(D.selectedFilters)!==eJ.current||D.useSearch2!==eY.current||D.hybridWeight!==eG.current||D.maxDistance!==eX.current,l=D.similarUid&&((null==eb?void 0:null===(e=eb.dataset_schema)||void 0===e?void 0:e.description)||(null==eb?void 0:null===(t=eb.extra_data)||void 0===t?void 0:t.description))||D.debouncedQuery;i&&(console.log("\uD83D\uDD0D Search parameters changed, clearing results and resetting to page 1"),J([]),ek([]),eZ.current=[],eF(void 0),e0.current=void 0,1!==eo&&ed(1),tt(l,1,{query:l,filters:D.selectedFilters,useSearch2:D.useSearch2,hybridWeight:D.hybridWeight,maxDistance:D.maxDistance,selectedCategory:D.selectedCategory,resourceType:D.resourceType,similarUid:D.similarUid}).finally(()=>{eK.current=D.debouncedQuery,eJ.current=JSON.stringify(D.selectedFilters),eY.current=D.useSearch2,eG.current=D.hybridWeight,eX.current=D.maxDistance,e$.current=eC}))},[D.debouncedQuery,D.selectedFilters,D.similarUid,eb,D.useSearch2,D.hybridWeight,D.maxDistance]),(0,r.useEffect)(()=>{if(eo>1){var e,t;console.log("\uD83D\uDCC4 Page changed to:",eo,"- loading more results"),tt(D.similarUid&&((null==eb?void 0:null===(e=eb.dataset_schema)||void 0===e?void 0:e.description)||(null==eb?void 0:null===(t=eb.extra_data)||void 0===t?void 0:t.description))||D.debouncedQuery,eo)}},[eo]);let te=(0,r.useCallback)(async()=>{if(console.log("\uD83D\uDD04 loadMore called:",{loadingMore:et,hasMoreResults:Z,currentPage:eo,resultsLength:E.length}),et||!Z){console.log("\uD83D\uDD04 loadMore early return:",{loadingMore:et,hasMoreResults:Z});return}let e=eo+1;console.log("\uD83D\uDD04 loadMore proceeding to page:",e),ed(e)},[et,Z,eo]);async function tt(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:D.debouncedQuery,t=arguments.length>1?arguments[1]:void 0;arguments.length>2&&arguments[2];let i=void 0!==t?t:eo;1===i?$(!0):ea(!0),ev(!1);let l=Date.now();1===i&&(ee(!0),ea(!1));try{var r,a;let t;let s={...D.selectedFilters};eP&&(s.resource_type=[eP]),Object.keys(s).forEach(e=>{Array.isArray(s[e])&&0===s[e].length&&delete s[e]});let n="search-".concat(Date.now());console.group("\uD83D\uDD0D Search Request: ".concat(n)),console.log("Search query:",e||"(empty)"),console.log("Filters:",s),console.log("Page:",i),console.log("Results per page:",50),console.log("Use Search2:",D.useSearch2),console.log("Similar UID (will be excluded):",D.similarUid||"None"),console.log("Top Level IDs Seen:",i>1?eC:"First page");let o=new Promise((e,t)=>{setTimeout(()=>t(Error("API request timed out")),6e4)}),d=Date.now();i>1?t=eZ.current:D.similarUid&&(t=[D.similarUid],console.log("Excluding original study from similar search:",D.similarUid));let c=await Promise.race([(0,W.Hu)(e,s,i,50,D.useSearch2,D.hybridWeight,t,i>1?e0.current:void 0,void 0,D.maxDistance),o]),u=Date.now()-d;ew(u),console.log("Response received:",{requestId:n,numHits:c.num_hits,resultCount:(null===(r=c.results)||void 0===r?void 0:r.length)||0,apiTime:"".concat(u,"ms"),results:null===(a=c.results)||void 0===a?void 0:a.map(e=>{var t,i,l,r;return{id:null===(t=e.extra_data)||void 0===t?void 0:t.uuid,title:null===(i=e.dataset_schema)||void 0===i?void 0:i.name,type:(null===(l=e.extra_data)||void 0===l?void 0:l.resource_type)||(null===(r=e.dataset_schema)||void 0===r?void 0:r["@type"]),similarity:e.cosine_similarity}}),timestamp:new Date().toISOString()}),console.groupEnd();let h=c.results||[];if(c.top_level_ids_seen_so_far?(console.log("Received top_level_ids_seen_so_far:",{count:c.top_level_ids_seen_so_far.length,sample:c.top_level_ids_seen_so_far.slice(0,5),previousCount:eC.length}),ek(c.top_level_ids_seen_so_far),eZ.current=c.top_level_ids_seen_so_far):console.log("No top_level_ids_seen_so_far in response"),void 0!==c.next_page_offset?(console.log("Received next_page_offset:",{offset:c.next_page_offset,previousOffset:e0.current}),eF(c.next_page_offset),e0.current=c.next_page_offset):console.log("No next_page_offset in response (using calculated offset)"),1===i){if(J(h),en(c.num_hits||0),D.useSearch2)ee(50===h.length&&h.length<(c.num_hits||0));else{let e=h.length>0;ee(e),(!e||h.length<50)&&en(Math.max(c.num_hits||0,h.length)),h.length>0&&h.length<50&&h.length<20&&(console.log("\uD83D\uDD04 Auto-loading next page from first page - insufficient results:",{gotResults:h.length,requestedResults:50,minThreshold:20,nextPage:2}),setTimeout(()=>{!et&&Z&&ed(2)},100))}}else{J(e=>{if(h.length>0){let t;t=1===i?h.length:e.length+h.length,h.length<50&&t<20&&(console.log("\uD83D\uDD04 Auto-loading next page - insufficient results:",{gotResults:h.length,requestedResults:50,currentTotal:t,minThreshold:20,nextPage:i+1}),setTimeout(()=>{!et&&Z&&ed(i+1)},100))}return[...e,...h]});let e=h.length>0;ee(e),e||en(Math.max(es,E.length+h.filter(e=>!E.some(t=>{var i,l;return(null===(i=t.extra_data)||void 0===i?void 0:i.uuid)===(null===(l=e.extra_data)||void 0===l?void 0:l.uuid)})).length))}let x=Date.now();eS(x-l)}catch(e){console.error("Search failed:",e),ev(!0),eS(null),ew(null)}finally{$(!1),ea(!1)}}let ti=async(e,t)=>{if(e)try{await z(e,t),console.log("Feedback submitted successfully")}catch(e){console.error("Failed to submit feedback:",e)}},tl=e=>{let t=[],i=["sample_size","age_lower","age_upper","start_year","end_year","duration_years","num_sweeps"],l=1/0,r=-1/0;if(Object.entries(e).forEach(e=>{let[a,s]=e;if("age_lower"===a||"age_upper"===a||"age_min"===a||"age_max"===a){let e=s.statistics||{},t=e.minimum;"number"==typeof t&&isFinite(t)||(t=e.min);let i=e.maximum;"number"==typeof i&&isFinite(i)||(i=e.max),"number"==typeof t&&isFinite(t)&&(l=Math.min(l,t)),"number"==typeof i&&isFinite(i)&&(r=Math.max(r,i));return}if(i.includes(a)){let e,i;let l=s.statistics||{};"number"==typeof l.minimum&&isFinite(l.minimum)?e=l.minimum:"number"==typeof l.min&&isFinite(l.min)?e=l.min:(console.warn("Missing valid min value for ".concat(a,", using default")),e="sample_size"===a?0:"start_year"===a||"end_year"===a?1900:0),"number"==typeof l.maximum&&isFinite(l.maximum)?i=l.maximum:"number"==typeof l.max&&isFinite(l.max)?i=l.max:(console.warn("Missing valid max value for ".concat(a,", using default")),i="sample_size"===a?1e5:"start_year"===a||"end_year"===a?2024:"duration_years"===a?100:"num_sweeps"===a?50:100),i<=e&&(i=e+1);let r=Array.from({length:101},(t,l)=>String(e+l/100*(i-e)));t.push({id:a,label:a.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),type:"range",options:r})}else{let e=s.buckets||[];e.length>0&&t.push({id:a,label:a.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),type:"multiselect",options:e.map(e=>e.key||"")})}}),isFinite(l)&&isFinite(r)&&l<=r){r<=l&&(r=l+1);let e=Array.from({length:101},(e,t)=>String(l+t/100*(r-l)));t.push({id:"age_range",label:"Age Range",type:"range",options:e})}else{console.warn("Missing valid age range data, using defaults");let e=Array.from({length:101},(e,t)=>String(0+t/100*100));t.push({id:"age_range",label:"Age Range",type:"range",options:e})}return t},tr=(0,r.useCallback)(async e=>{var t,i,l,r,a;let s=null===(t=e.extra_data)||void 0===t?void 0:t.uuid;if(!s)return;let n=(null===(i=e.dataset_schema)||void 0===i?void 0:i.name)||(null===(l=e.extra_data)||void 0===l?void 0:l.name)||"Unnamed Study";F("LIKE:".concat(n," (").concat(s,")"));let o=(null===(r=e.dataset_schema)||void 0===r?void 0:r.description)||(null===(a=e.extra_data)||void 0===a?void 0:a.description);o?(F(o),ta(o)):(console.warn("No description available for study ".concat(n,", using name for similar search")),F(n),ta(n))},[]),ta=async e=>{$(!0),ev(!1);try{let t;let i={...D.selectedFilters};eP&&(i.resource_type=[eP]),Object.keys(i).forEach(e=>{Array.isArray(i[e])&&0===i[e].length&&delete i[e]});let l=e,r=e.match(/^LIKE:(.*?)\s*\(([^)]+)\)$/);r&&(t=r[2],l="LIKE:".concat(t));let a=await (0,W.Hu)(l,i,eo,50,D.useSearch2,D.hybridWeight,t?[t]:eo>1?eZ.current:void 0,eo>1?e0.current:void 0,void 0,D.maxDistance);J(a.results||[]),en(a.num_hits||0)}catch(e){ev(!0)}finally{$(!1)}};return(0,l.jsxs)(n.default,{sx:{height:"100vh",overflow:"hidden",display:"flex",flexDirection:"column"},children:[(0,l.jsxs)(o.A,{maxWidth:"xl",sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",py:{xs:2,sm:3,md:4}},children:[(0,l.jsx)(n.default,{sx:{display:"flex",alignItems:"center",gap:3,mb:{xs:2,sm:3,md:4}},children:eO?(0,l.jsxs)(n.default,{sx:{display:"flex",alignItems:"center",gap:3,width:"100%",p:3,bgcolor:"background.paper",borderRadius:2,boxShadow:1},children:[(0,l.jsx)(n.default,{sx:{width:120,height:120,display:"flex",alignItems:"center",justifyContent:"center",color:"grey.500"},children:(null==eb?void 0:null===(e=eb.dataset_schema)||void 0===e?void 0:e.image)?(0,l.jsx)(f.default,{src:(null==eb?void 0:eb.dataset_schema).image,alt:(null==eb?void 0:null===(t=eb.dataset_schema)||void 0===t?void 0:t.name)||"Study",width:100,height:100,style:{objectFit:"contain"},unoptimized:!0}):(e=>{var t,i;let r=(null==e?void 0:null===(t=e.extra_data)||void 0===t?void 0:t.resource_type)||(null==e?void 0:null===(i=e.dataset_schema)||void 0===i?void 0:i["@type"]);return(null==r?void 0:r.includes("dataset"))?(0,l.jsx)(L.A,{size:48}):(null==r?void 0:r.includes("variable"))?(0,l.jsx)(B.A,{size:48}):(null==r?void 0:r.includes("study"))?(0,l.jsx)(N.A,{size:48}):(0,l.jsx)(H.A,{size:48})})(eb)}),(0,l.jsxs)(n.default,{children:[(0,l.jsx)(d.A,{variant:"h4",gutterBottom:!0,children:(null==eb?void 0:null===(i=eb.dataset_schema)||void 0===i?void 0:i.name)||(null==eb?void 0:null===(y=eb.extra_data)||void 0===y?void 0:y.name)||"Unnamed Study"}),(0,l.jsx)(d.A,{variant:"subtitle1",color:"text.secondary",children:"Similar Studies"})]})]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(c.A,{fullWidth:!0,placeholder:"What are you searching for?",value:D.query,onChange:e=>{F(e.target.value)},InputProps:{endAdornment:(0,l.jsxs)(n.default,{sx:{mr:1,ml:-.5,display:"flex",alignItems:"center",gap:1},children:[D.query!==D.debouncedQuery&&(0,l.jsx)(d.A,{variant:"caption",color:"text.secondary",sx:{fontSize:{xs:"0.6rem",sm:"0.7rem"}},children:"Typing..."}),(0,l.jsx)(f.default,{src:(0,el.xC)()+"icons/discover.svg",alt:"Search",width:20,height:20})]}),sx:{height:48,"& .MuiOutlinedInput-root":{borderRadius:24},"& .MuiOutlinedInput-notchedOutline":{borderColor:"grey.200"}}},sx:{"& .MuiOutlinedInput-root":{borderRadius:24}}}),(0,l.jsx)(n.default,{sx:{display:"flex",alignItems:"center",gap:2},children:(0,l.jsx)(ei,{})})]})}),(0,l.jsx)(b.A,{filtersData:Y}),!ep&&(0,l.jsxs)(n.default,{sx:{mb:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,l.jsxs)(d.A,{variant:"body2",color:"text.secondary",children:[X?"Searching...":Z?E.length>es?"".concat(E.length," results loaded (").concat(es,"+ estimated)"):es>0?"".concat(E.length," of ~").concat(es," results loaded"):"".concat(E.length," results loaded"):"".concat(E.length," results found"),!X&&eA&&" (API: ".concat(eA,"ms"),!X&&e_&&eA&&", Total: ".concat(e_,"ms)")]}),ez&&(0,l.jsx)(u.A,{variant:"outlined",size:"small",startIcon:eI?(0,l.jsx)(M.A,{size:16,fill:"currentColor"}):(0,l.jsx)(M.A,{size:16}),onClick:e9,disabled:eR||!D.query.trim()||X,sx:{ml:2,color:eI?"success.main":"inherit",borderColor:eI?"success.main":"inherit"},title:"Save this search",children:eR?"Saving...":eI?"Saved!":"Save Search"})]}),E.length||X||""!==D.query.trim()||0!==Object.keys(D.selectedFilters).length||0!==eV.length||eB||0!==eN.length||0!==eH.length||0!==eQ.length?(0,l.jsxs)(n.default,{sx:{display:w?"block":"flex",width:"100%",flex:1,minHeight:0,overflow:"visible",position:"relative"},children:[(0,l.jsx)(n.default,{sx:{width:C?"100%":"50%",minWidth:w?"100%":"300px",overflowX:"hidden",display:"flex",flexDirection:"column",height:"100%",position:"relative"},children:X?(0,l.jsx)(d.A,{children:"Loading search results..."}):ep?(0,l.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",py:8,px:4,height:"100%"},children:[(0,l.jsx)(g.A,{sx:{fontSize:{xs:48,sm:64},color:"text.secondary",mb:2}}),(0,l.jsx)(d.A,{variant:"h5",color:"text.secondary",gutterBottom:!0,children:"The discovery API is currently offline"}),(0,l.jsx)(d.A,{color:"text.secondary",children:"Please try again soon. We apologize for the inconvenience."}),(0,l.jsx)(u.A,{variant:"contained",sx:{mt:4},onClick:()=>{ev(!1),tt()},children:"Retry Connection"})]}):(0,l.jsx)(n.default,{sx:{flex:1,overflowY:"auto",minHeight:0,display:"flex",flexDirection:"column"},id:"search-results-container",children:(0,l.jsx)(er.A,{dataLength:E.length,next:te,hasMore:Z,loader:(0,l.jsx)(n.default,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:3},children:(0,l.jsx)(Q.A,{size:24,className:"animate-spin",style:{color:"#1976d2"}})}),scrollableTarget:"search-results-container",endMessage:(0,l.jsx)(d.A,{children:"No more results to load."}),children:(0,l.jsx)(v,{results:E,resourceTypeFilter:eV,onSelectResult:e2,selectedResultId:null==ec?void 0:null===(p=ec.extra_data)||void 0===p?void 0:p.uuid,onFindSimilar:tr,hasActiveSearch:""!==D.query.trim()||Object.keys(D.selectedFilters).length>0||eV.length>0})})})}),!w&&(E.length>0||es>0)&&(0,l.jsxs)(n.default,{sx:{position:"absolute",top:0,right:0,width:ef?"calc(100% - 130px)":C?"0%":"50%",height:"100%",bgcolor:"background.paper",borderLeft:C&&!ef?"none":"1px solid",borderColor:"grey.200",display:"flex",flexDirection:"column",overflow:"visible",transition:"width 0.3s ease-in-out",cursor:ec?"pointer":"default",zIndex:ef?2:1,boxShadow:ef?"-4px 0 8px rgba(0, 0, 0, 0.1)":"none"},onClick:e4,children:[(0,l.jsx)(n.default,{sx:{position:"absolute",top:-16,left:-16,zIndex:1e3},children:(0,l.jsx)(h.A,{onClick:e=>{e.stopPropagation(),e6()},sx:{bgcolor:"primary.main",color:"white","&:hover":{bgcolor:"primary.dark"},boxShadow:2,width:30,height:30},children:ef?(0,l.jsx)(K.A,{size:20}):(0,l.jsx)(V.A,{size:20})})}),ep?(0,l.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",p:4,height:"100%"},children:[(0,l.jsx)(g.A,{sx:{fontSize:{xs:36,sm:48},color:"text.secondary",mb:2}}),(0,l.jsx)(d.A,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"API Offline"}),(0,l.jsx)(d.A,{variant:"body2",color:"text.secondary",children:"Study details unavailable"})]}):e8?(0,l.jsx)(n.default,{sx:{height:"100%",overflowY:"auto",minHeight:0},children:(0,l.jsx)(j.default,{study:e8,isDrawerView:!1})}):(0,l.jsx)(n.default,{sx:{display:"flex",height:"100%",alignItems:"center",justifyContent:"center",p:2},children:(0,l.jsx)(d.A,{color:"text.secondary",children:"Select a dataset to view details"})})]})]}):(0,l.jsx)(n.default,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",width:"100%"},children:(0,l.jsx)(n.default,{sx:{width:"80%",maxWidth:1200},children:(0,l.jsx)(R,{onExampleClick:e=>{F(e)}})})}),(0,l.jsxs)(x.Ay,{anchor:"right",open:w&&eh,onClose:e5,sx:{"& .MuiDrawer-paper":{width:{xs:"100%",sm:"80%",md:"60%"},maxWidth:"600px",p:0,overflow:"hidden",display:"flex",flexDirection:"column"}},children:[(0,l.jsxs)(n.default,{sx:{position:"sticky",top:0,zIndex:10,bgcolor:"background.paper",borderBottom:"1px solid",borderColor:"grey.200",p:1},children:[(0,l.jsx)(h.A,{onClick:e5,sx:{position:"absolute",top:8,right:8},children:(0,l.jsx)(m.A,{})}),(0,l.jsxs)(n.default,{sx:{py:1,pl:1,pr:6,display:"flex",alignItems:"center",gap:2},children:[(0,l.jsx)(d.A,{variant:"h6",sx:{flex:1},children:ec&&(null===(_=ec.dataset_schema)||void 0===_?void 0:_.name)||"Study Details"}),ec&&(ec.dataset_schema&&ec.dataset_schema.image||ec.image)&&!em&&(0,l.jsx)(n.default,{sx:{width:50,height:50,position:"relative",borderRadius:"4px",overflow:"hidden",flexShrink:0},children:(0,l.jsx)(f.default,{src:ec.dataset_schema&&ec.dataset_schema.image||ec.image,alt:(null===(S=ec.dataset_schema)||void 0===S?void 0:S.name)||"Study image",fill:!0,style:{objectFit:"contain"},onError:()=>eg(!0),unoptimized:!0})})]})]}),(0,l.jsx)(n.default,{sx:{p:0,overflow:"hidden",display:"flex",flexDirection:"column",flex:1},children:e8?(0,l.jsx)(j.default,{studyDataComplete:!1,study:e8,isDrawerView:!0}):(0,l.jsx)(n.default,{sx:{display:"flex",height:"100%",alignItems:"center",justifyContent:"center",p:2},children:(0,l.jsx)(d.A,{color:"text.secondary",children:"Select a dataset to view details"})})})]})]}),(0,l.jsx)(k,{onSubmitFeedback:ti})]})}function es(){return(0,l.jsx)(r.Suspense,{fallback:(0,l.jsx)(n.default,{sx:{p:4},children:(0,l.jsx)(d.A,{children:"Loading..."})}),children:(0,l.jsx)(ea,{})})}}}]);