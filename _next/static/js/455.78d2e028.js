(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[455],{5225:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});let r=(0,n(14294).A)("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]])},8325:()=>{},40455:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>L});var r=n(95155),l=n(12115),o=n(50077),i=n(17231),s=n(38912),a=n(1151),u=n(94049),c=n(25635),d=n(78470),h=n(56153),m=n(41602),p=n(23820),x=n(49501),y=n(17681),f=n(2778),g=n(52363),v=n(65036),j=n(92925),b=n(53489),w=n(14294);let k=(0,w.A)("FileJson",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 12a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1 1 1 0 0 1 1 1v1a1 1 0 0 0 1 1",key:"1oajmo"}],["path",{d:"M14 18a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1 1 1 0 0 1-1-1v-1a1 1 0 0 0-1-1",key:"mpwhp6"}]]);var _=n(5225);let A=(0,w.A)("Table",[["path",{d:"M12 3v18",key:"108xh3"}],["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}]]),C=(0,w.A)("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),q=(0,w.A)("Maximize2",[["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["polyline",{points:"9 21 3 21 3 15",key:"1avn1i"}],["line",{x1:"21",x2:"14",y1:"3",y2:"10",key:"ota7mn"}],["line",{x1:"3",x2:"10",y1:"21",y2:"14",key:"1atl0r"}]]);var S=n(75183);let z=!1,M=null,R=async()=>{if(!z)return M||(M=new Promise((e,t)=>{if(customElements.get("harmony-export")){console.log("\uD83D\uDD0D Harmony export component already registered"),z=!0,M=null,e();return}console.log("\uD83D\uDD0D Loading harmony-export web component");let n=document.createElement("script");n.src="/app/js/harmony-export.js",n.async=!0,n.onload=()=>{console.log("✅ Harmony export component loaded successfully"),z=!0,M=null,e()},n.onerror=e=>{console.error("❌ Failed to load harmony-export component:",e),M=null,t(e)},document.head.appendChild(n)}))};function E(e){let{variables:t,studyName:n,studyUuid:f,studyAncestors:g,query:v,variablesWhichMatched:w,alpha:C,maxVectorDistance:q,maxDistanceMode:z,directMatchWeight:M,onTotalCountChange:E,onShouldHideTable:L,downloadAnchorEl:N,onDownloadClick:T,onDownloadClose:O}=e,D=(0,l.useRef)(null),H=(0,l.useRef)(null),[I,U]=(0,l.useState)(!1),[F,V]=(0,l.useState)(null),[X,Q]=(0,l.useState)(!1),[W,G]=(0,l.useState)(""),[P,B]=(0,l.useState)(!1),[J,Z]=(0,l.useState)(!1),K=(0,l.useRef)(null),Y=(0,l.useRef)(null),$=(0,l.useMemo)(()=>w&&w.length>0&&v&&v.trim().length>0?{filter:{filterModel:{items:[],quickFilterValues:[v.trim()]}}}:{filter:{filterModel:{items:[],quickFilterValues:[]}}},[v,w]),ee=(0,l.useMemo)(()=>{if(f)return{getRows:async e=>{var t;let n=((null==(t=e.filterModel)?void 0:t.quickFilterValues)||[]).join(" ").trim(),r=e.paginationModel||{page:0,pageSize:50},l=e.sortModel||[];if(n&&n.trim().length>0)return K.current&&clearTimeout(K.current),Y.current&&Y.current.reject(Error("Request cancelled by new filter")),new Promise((e,t)=>{Y.current={resolve:e,reject:t},K.current=setTimeout(async()=>{var e,t;try{let t=await o();null==(e=Y.current)||e.resolve(t),Y.current=null}catch(e){null==(t=Y.current)||t.reject(e),Y.current=null}},500)});return o();async function o(){let e;if(l&&l.length>0){let t=l[0],n=t.field,r=t.sort||"asc";e="".concat(n,":").concat(r)}G(n||"");let t={ancestor_uuid:f,num_results:r.pageSize,offset:r.page*r.pageSize};n&&n.trim()&&(t.query=n.trim(),t.alpha=C,t.max_vector_distance=q,t.max_distance_mode=z,t.direct_match_weight=M),e&&(t.sort_order=e);try{let e,l=await (0,S.CO)(t),o=l.results||[];if(0===r.page){let e=o.some(e=>e.urls&&Array.isArray(e.urls)&&e.urls.length>0),t=o.some(e=>{let t=e.response_options||e.options;return t&&Array.isArray(t)&&t.length>0});B(e),Z(t)}0===r.page&&0===o.length&&(0===l.num_hits||void 0===l.num_hits)?n&&n.trim()?(Q(!1),null==L||L(!1)):(Q(!0),null==L||L(!0)):(Q(!1),null==L||L(!1));let i=new Set;w&&w.length>0&&w.forEach(e=>{e.name&&i.add(e.name)});let s=new Map;o.forEach(e=>{let t=e.name||"unnamed";s.set(t,(s.get(t)||0)+1)});let a=o.map((e,t)=>{let n=e.name||"unnamed",l=s.get(n)||1,o=r.page*r.pageSize,a="".concat(n,"-").concat(o,"-").concat(t),u=l>1?"".concat(n," (x").concat(l,")"):n,c=i.has(n);return{...e,id:a,originalIndex:t,displayName:u,repeatCount:l,matched:c}}),u=r.page*r.pageSize,c=n&&n.trim().length>0,d=o.length;return 0===u?(void 0!==l.num_hits&&null!==l.num_hits&&(V(l.num_hits),null==E||E(l.num_hits)),e=c?d<r.pageSize?d:r.pageSize:void 0!==l.num_hits&&null!==l.num_hits?l.num_hits:d<r.pageSize?d:-1):e=void 0!==l.num_hits&&null!==l.num_hits?l.num_hits:d<r.pageSize?u+d:null!==F?F:-1,{rows:a,rowCount:e}}catch(e){return console.error("Failed to fetch variables:",e),{rows:[],rowCount:0}}}}}},[f,C,q,z,M,w]);(0,l.useEffect)(()=>()=>{K.current&&clearTimeout(K.current),Y.current&&Y.current.reject(Error("Component unmounted"))},[]),(0,l.useEffect)(()=>{K.current&&(clearTimeout(K.current),K.current=null),Y.current&&(Y.current.reject(Error("Study changed")),Y.current=null),V(null),null==E||E(null)},[f,E]);let et=f?[]:t||[];(0,l.useEffect)(()=>{R().catch(e=>{console.error("Failed to load harmony-export component:",e)})},[]);let en=(0,l.useCallback)((e,t)=>{let n=e.question&&e.question.trim().length>0,r=e.description&&e.description.trim().length>0,l=e.name&&e.name.trim().length>0,o=(n||r)&&l?e.name:t,i="";i=n&&r?e.question.trim()===e.description.trim()?e.question:"".concat(e.question," [").concat(e.description,"]"):n?e.question:r?e.description:l?e.name:"";let s=e.response_options||e.options;return{question_no:o,question_text:i,response_options:s&&Array.isArray(s)?s.join(" / "):""}},[]),er=(0,l.useMemo)(()=>f?J:et.some(e=>{let t=e.response_options||e.options;return t&&Array.isArray(t)&&t.length>0}),[f,J,et]),el=(0,l.useMemo)(()=>f?P:et.some(e=>e.urls&&Array.isArray(e.urls)&&e.urls.length>0),[f,P,et]),eo=(0,l.useMemo)(()=>{let e=[{field:"question_no",headerName:"Code",width:120,valueGetter:(e,t)=>{var n;return en(t,null!=(n=t.originalIndex)?n:0).question_no},sortable:!0},{field:"description",headerName:"Question / Variable name",flex:2,valueGetter:(e,t)=>{var n,r;return t.displayName&&t.repeatCount>1?en(t,null!=(n=t.originalIndex)?n:0).question_text||t.displayName:en(t,null!=(r=t.originalIndex)?r:0).question_text},sortable:!0}];return er&&e.push({field:"options",headerName:"Response Options",flex:1,valueGetter:(e,t)=>{var n;return en(t,null!=(n=t.originalIndex)?n:0).response_options},sortable:!0}),el&&e.push({field:"url",headerName:"Learn more",width:120,sortable:!1,renderCell:e=>{let t=e.row,n=(null==t?void 0:t.urls)&&Array.isArray(t.urls)&&t.urls.length>0?t.urls[0]:null;return n?(0,r.jsx)(a.A,{size:"small",onClick:e=>{e.stopPropagation(),window.open(n,"_blank","noopener,noreferrer")},sx:{p:.5},children:(0,r.jsx)(j.A,{size:16})}):null},headerAlign:"center",align:"center"}),e},[er,el,en,et]),ei=et.filter(e=>e.name||e.description).map((e,t)=>({id:e.name||t,originalIndex:t,...e})),es=l.useRef(null);(0,l.useEffect)(()=>{let e=setTimeout(()=>{es.current&&U(!0)},200);return()=>clearTimeout(e)},[es]);let ea=()=>{let e=es.current;if(!e||!I)return[];try{let t=e.getSelectedRows();return t?Array.from(t.values()):[]}catch(e){return console.warn("Failed to get selected items:",e),[]}},eu=(0,l.useCallback)(()=>{if(!D.current||!I)return;let e=ea();if(D.current.innerHTML="",0===e.length)return;console.log("selectedItems:",e);let t=e.map(e=>{var t;let n=en(e,null!=(t=e.originalIndex)?t:0);return{question_no:n.question_no,question_text:n.question_text}}),r=document.createElement("harmony-export");r.size="32px",r.instrument_name="".concat(n||"Selected Variables"," from harmonydata.ac.uk/discover"),r.questions=t,D.current.appendChild(r)},[I,n]);(0,l.useEffect)(()=>{if(!I||!es.current)return;let e=es.current.subscribeEvent("rowSelectionChange",()=>{eu()});return()=>{e()}},[I,eu]);let ec=()=>{null==O||O()},ed=()=>{let e,t=es.current;if(!t||!I)return[];try{e=t.getSelectedRows()}catch(t){e=null}return(e&&"number"==typeof e.size&&e.size>0&&e?Array.from(e.values()):(()=>{let e;try{e=t.getRowModels()}catch(t){e=null}return e?Array.from(e.values()):[]})()).map(e=>{var t;let n=en(e,null!=(t=e.originalIndex)?t:0),r={question_no:n.question_no,question_text:n.question_text};return er&&(r.response_options=n.response_options),r})},eh=async()=>{let e=ed();await new Promise((e,t)=>{if(window.XLSX)return void e();let n=document.querySelector('script[src="/js/xlsx.min.js"]');if(n){n.addEventListener("load",()=>e()),n.addEventListener("error",t);return}let r=document.createElement("script");r.src="/js/xlsx.min.js",r.async=!0,r.onload=()=>e(),r.onerror=t,document.head.appendChild(r)});let t=window.XLSX||globalThis.XLSX;if(!t){console.error("XLSX library failed to load"),ec();return}let n=t.utils.json_to_sheet(e),r=t.utils.book_new();t.utils.book_append_sheet(r,n,"Questions");let l=new Blob([t.write(r,{bookType:"xlsx",type:"array"})],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),o=URL.createObjectURL(l),i=document.createElement("a");i.href=o,i.download="questions.xlsx",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o),ec()};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(u.default,{sx:{height:"100%",minHeight:400},children:(ei.length>0||ee)&&(0,r.jsx)(o.z,{apiRef:es,...ee?{dataSource:ee}:{rows:ei},columns:eo,checkboxSelection:!0,sortModel:[],getRowClassName:e=>e.row.matched?"matched-row":"",filterMode:"client",sortingMode:"client",paginationMode:f?"server":"client",sx:{background:"white",borderRadius:2,fontSize:14,height:"100%","& .matched-row":{backgroundColor:"#fffae4","&:hover":{backgroundColor:"#fff8d1"}}},hideFooter:!f,pageSizeOptions:[20,50,100],pagination:!0,showToolbar:!0,initialState:$,slots:{noRowsOverlay:()=>(0,r.jsx)(u.default,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",p:4},children:(0,r.jsx)(c.A,{variant:"body1",color:"text.secondary",children:W&&W.trim()?"No variables match your query. Remove it to see them all.":"No variables found."})}),toolbar:()=>(0,r.jsxs)(u.default,{sx:{display:"flex",alignItems:"center",gap:2,p:1,mr:2,flexWrap:"wrap"},children:[(0,r.jsx)(u.default,{sx:{flex:1,minWidth:200},children:(0,r.jsx)(i.e,{expanded:!0,style:{width:"100%"},children:(0,r.jsx)(s.X,{placeholder:"Search within variables",style:{background:"white",borderRadius:192,fontSize:14}})})}),(0,r.jsx)(d.A,{title:"Harmonise selected items",children:(0,r.jsx)(a.A,{size:"small",sx:{width:40,height:40},children:(0,r.jsx)(u.default,{ref:D,sx:{display:"flex",alignItems:"center",justifyContent:"center",width:20,height:20}})})}),(0,r.jsx)(d.A,{title:(()=>{let e=es.current;if(!e||!I)return!1;try{let t=e.getSelectedRows();return t&&"number"==typeof t.size&&t.size>0}catch(e){return!1}})()?"Download ".concat(ea().length," selected questions"):"Download all questions",children:(0,r.jsx)(a.A,{ref:H,size:"small",onClick:T,sx:{width:40,height:40},children:(0,r.jsx)(b.A,{size:30})})})]})}})}),(0,r.jsx)(h.Ay,{open:!!N,anchorEl:N,onClose:ec,anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"center"},children:(0,r.jsxs)(m.A,{sx:{width:200},children:[(0,r.jsxs)(p.Ay,{onClick:()=>{let e=new Blob([JSON.stringify(ed(),null,2)],{type:"application/json"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="questions.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),ec()},sx:{cursor:"pointer"},children:[(0,r.jsx)(x.A,{children:(0,r.jsx)(k,{size:20})}),(0,r.jsx)(y.A,{primary:"Download as JSON"})]}),(0,r.jsxs)(p.Ay,{onClick:()=>{let e=new Blob([[er?["Question Number","Question Text","Response Options"]:["Question Number","Question Text"],...ed().map(e=>er?[e.question_no,e.question_text,e.response_options]:[e.question_no,e.question_text])].map(e=>e.map(e=>'"'.concat(e,'"')).join(",")).join("\n")],{type:"text/csv"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="questions.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),ec()},sx:{cursor:"pointer"},children:[(0,r.jsx)(x.A,{children:(0,r.jsx)(_.A,{size:20})}),(0,r.jsx)(y.A,{primary:"Download as CSV"})]}),(0,r.jsxs)(p.Ay,{onClick:eh,sx:{cursor:"pointer"},children:[(0,r.jsx)(x.A,{children:(0,r.jsx)(A,{size:20})}),(0,r.jsx)(y.A,{primary:"Download as Excel"})]})]})})]})}function L(e){let{variables:t,studyName:n,studyUuid:o,studyAncestors:i,query:s,variablesWhichMatched:h,alpha:m,maxVectorDistance:p,maxDistanceMode:x,directMatchWeight:y,onTotalCountChange:j,onShouldHideTable:b}=e,[w,k]=(0,l.useState)(!1),_=(0,l.useRef)(null),[A,S]=(0,l.useState)(null),z=()=>{S(null),k(!1)},M=(0,r.jsx)(E,{variables:t,studyName:n,studyUuid:o,studyAncestors:i,query:s,variablesWhichMatched:h,alpha:m,maxVectorDistance:p,maxDistanceMode:x,directMatchWeight:y,onTotalCountChange:j,onShouldHideTable:b,downloadAnchorEl:A,onDownloadClick:e=>{console.log("handleDownloadClick",e.currentTarget),S(_.current)},onDownloadClose:()=>{S(null)}});return w?(0,r.jsxs)(f.A,{ref:_,open:!0,onClose:z,maxWidth:"xl",fullWidth:!0,sx:{"& .MuiDialog-paper":{height:"90vh",maxHeight:"90vh"}},children:[(0,r.jsxs)(g.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pb:1},children:[(0,r.jsxs)(c.A,{variant:"h6",children:["Variables - ",n||"Study"]}),(0,r.jsx)(a.A,{onClick:z,size:"small",sx:{color:"text.secondary"},children:(0,r.jsx)(C,{size:20})})]}),(0,r.jsx)(v.A,{sx:{p:0,overflow:"hidden"},children:(0,r.jsx)(u.default,{sx:{height:"100%","& .MuiDataGrid-root":{borderRadius:0,maxHeight:"none",height:"100%"}},children:M})})]}):(0,r.jsxs)(u.default,{ref:_,sx:{position:"relative"},children:[(0,r.jsx)(u.default,{sx:{position:"absolute",top:8,right:8,zIndex:10,backgroundColor:"rgba(255, 255, 255, 0.9)",borderRadius:1},children:(0,r.jsx)(d.A,{title:"Open in large view",children:(0,r.jsx)(a.A,{size:"small",onClick:()=>{S(null),k(!0)},children:(0,r.jsx)(q,{size:20})})})}),(0,r.jsx)(u.default,{sx:{"& .MuiDataGrid-root":{height:450,borderRadius:2}},children:M})]})}n(8325)},53489:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});let r=(0,n(14294).A)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]])}}]);