(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[455],{5225:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});let r=(0,n(14294).A)("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]])},8325:()=>{},40455:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>L});var r=n(95155),l=n(12115),o=n(50077),i=n(17231),s=n(38912),a=n(1151),u=n(94049),c=n(78470),d=n(56153),h=n(41602),p=n(23820),m=n(49501),x=n(17681),y=n(2778),g=n(52363),f=n(25635),v=n(65036),w=n(92925),b=n(53489),j=n(14294);let k=(0,j.A)("FileJson",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 12a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1 1 1 0 0 1 1 1v1a1 1 0 0 0 1 1",key:"1oajmo"}],["path",{d:"M14 18a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1 1 1 0 0 1-1-1v-1a1 1 0 0 0-1-1",key:"mpwhp6"}]]);var _=n(5225);let A=(0,j.A)("Table",[["path",{d:"M12 3v18",key:"108xh3"}],["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}]]),C=(0,j.A)("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),q=(0,j.A)("Maximize2",[["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["polyline",{points:"9 21 3 21 3 15",key:"1avn1i"}],["line",{x1:"21",x2:"14",y1:"3",y2:"10",key:"ota7mn"}],["line",{x1:"3",x2:"10",y1:"21",y2:"14",key:"1atl0r"}]]);var z=n(75183);let M=!1,S=null,R=async()=>{if(!M)return S||(S=new Promise((e,t)=>{if(customElements.get("harmony-export")){console.log("\uD83D\uDD0D Harmony export component already registered"),M=!0,S=null,e();return}console.log("\uD83D\uDD0D Loading harmony-export web component");let n=document.createElement("script");n.src="/app/js/harmony-export.js",n.async=!0,n.onload=()=>{console.log("✅ Harmony export component loaded successfully"),M=!0,S=null,e()},n.onerror=e=>{console.error("❌ Failed to load harmony-export component:",e),S=null,t(e)},document.head.appendChild(n)}))};function E(e){let{variables:t,studyName:n,studyUuid:y,studyAncestors:g,query:f,variablesWhichMatched:v,alpha:j,maxVectorDistance:C,maxDistanceMode:q,directMatchWeight:M,onTotalCountChange:S,onShouldHideTable:E,downloadAnchorEl:L,onDownloadClick:T,onDownloadClose:O}=e,N=(0,l.useRef)(null),D=(0,l.useRef)(null),[H,I]=(0,l.useState)(!1),[U,F]=(0,l.useState)(null),[V,X]=(0,l.useState)(!1),Q=(0,l.useRef)(null),W=(0,l.useRef)(null),G=(0,l.useMemo)(()=>v&&v.length>0&&f&&f.trim().length>0?{filter:{filterModel:{items:[],quickFilterValues:[f.trim()]}}}:{filter:{filterModel:{items:[],quickFilterValues:[]}}},[f,v]),P=(0,l.useMemo)(()=>{if(y)return{getRows:async e=>{var t,n;let r=(null==(n=e.filterModel)||null==(t=n.quickFilterValues)?void 0:t[0])||"",l=e.paginationModel||{page:0,pageSize:50},o=e.sortModel||[];if(r&&r.trim().length>0)return Q.current&&clearTimeout(Q.current),W.current&&W.current.reject(Error("Request cancelled by new filter")),new Promise((e,t)=>{W.current={resolve:e,reject:t},Q.current=setTimeout(async()=>{var e,t;try{let t=await i();null==(e=W.current)||e.resolve(t),W.current=null}catch(e){null==(t=W.current)||t.reject(e),W.current=null}},500)});return i();async function i(){let e;if(o&&o.length>0){let t=o[0],n=t.field,r=t.sort||"asc";e="".concat(n,":").concat(r)}let t={ancestor_uuid:y,num_results:l.pageSize,offset:l.page*l.pageSize};r&&r.trim()&&(t.query=r.trim(),t.alpha=j,t.max_vector_distance=C,t.max_distance_mode=q,t.direct_match_weight=M),e&&(t.sort_order=e);try{let e,n=await (0,z.CO)(t),o=n.results||[];if(0===o.length&&r&&r.trim()&&0===l.page&&l.pageSize>0){let e={...t,query:void 0};o=(n=await (0,z.CO)(e)).results||[],0===o.length&&(0===n.num_hits||void 0===n.num_hits)?(X(!0),null==E||E(!0)):(X(!1),null==E||E(!1))}else 0===l.page&&0===o.length&&(0===n.num_hits||void 0===n.num_hits)?(X(!0),null==E||E(!0)):(X(!1),null==E||E(!1));let i=new Set;v&&v.length>0&&v.forEach(e=>{e.name&&i.add(e.name)});let s=new Map;o.forEach(e=>{let t=e.name||"unnamed";s.set(t,(s.get(t)||0)+1)});let a=o.map((e,t)=>{let n=e.name||"unnamed",r=s.get(n)||1,o=l.page*l.pageSize,a="".concat(n,"-").concat(o,"-").concat(t),u=r>1?"".concat(n," (x").concat(r,")"):n,c=i.has(n);return{...e,id:a,originalIndex:t,displayName:u,repeatCount:r,matched:c}}),u=l.page*l.pageSize,c=r&&r.trim().length>0,d=o.length;return 0===u?(void 0!==n.num_hits&&null!==n.num_hits&&(F(n.num_hits),null==S||S(n.num_hits)),e=c?d<l.pageSize?d:l.pageSize:void 0!==n.num_hits&&null!==n.num_hits?n.num_hits:d<l.pageSize?d:-1):e=void 0!==n.num_hits&&null!==n.num_hits?n.num_hits:d<l.pageSize?u+d:null!==U?U:-1,{rows:a,rowCount:e}}catch(e){return console.error("Failed to fetch variables:",e),{rows:[],rowCount:0}}}}}},[y,j,C,q,M,v]);(0,l.useEffect)(()=>()=>{Q.current&&clearTimeout(Q.current),W.current&&W.current.reject(Error("Component unmounted"))},[]),(0,l.useEffect)(()=>{Q.current&&(clearTimeout(Q.current),Q.current=null),W.current&&(W.current.reject(Error("Study changed")),W.current=null),F(null),null==S||S(null)},[y,S]);let B=y?[]:t||[];(0,l.useEffect)(()=>{R().catch(e=>{console.error("Failed to load harmony-export component:",e)})},[]);let J=(0,l.useCallback)((e,t)=>{let n=e.question&&e.question.trim().length>0,r=e.description&&e.description.trim().length>0,l=e.name&&e.name.trim().length>0,o=(n||r)&&l?e.name:t,i="";i=n&&r?e.question.trim()===e.description.trim()?e.question:"".concat(e.question," [").concat(e.description,"]"):n?e.question:r?e.description:l?e.name:"";let s=e.response_options||e.options;return{question_no:o,question_text:i,response_options:s&&Array.isArray(s)?s.join(" / "):""}},[]),Z=(0,l.useMemo)(()=>B.some(e=>{let t=e.response_options||e.options;return t&&Array.isArray(t)&&t.length>0}),[B]),K=(0,l.useMemo)(()=>B.some(e=>e.urls&&Array.isArray(e.urls)&&e.urls.length>0),[B]),Y=(0,l.useMemo)(()=>{let e=[{field:"question_no",headerName:"Code",width:120,valueGetter:(e,t)=>{var n;return J(t,null!=(n=t.originalIndex)?n:0).question_no},sortable:!0},{field:"description",headerName:"Question / Variable name",flex:2,valueGetter:(e,t)=>{var n,r;return t.displayName&&t.repeatCount>1?J(t,null!=(n=t.originalIndex)?n:0).question_text||t.displayName:J(t,null!=(r=t.originalIndex)?r:0).question_text},sortable:!0}];return Z&&e.push({field:"options",headerName:"Response Options",flex:1,valueGetter:(e,t)=>{var n;return J(t,null!=(n=t.originalIndex)?n:0).response_options},sortable:!0}),K&&e.push({field:"url",headerName:"",width:60,sortable:!1,renderCell:e=>{var t;let n=B[null!=(t=e.row.originalIndex)?t:0],l=(null==n?void 0:n.urls)&&Array.isArray(n.urls)&&n.urls.length>0?n.urls[0]:null;return l?(0,r.jsx)(a.A,{size:"small",onClick:e=>{e.stopPropagation(),window.open(l,"_blank","noopener,noreferrer")},sx:{p:.5},children:(0,r.jsx)(w.A,{size:16})}):null},headerAlign:"center",align:"center"}),e},[Z,K,J,B]),$=B.filter(e=>e.name||e.description).map((e,t)=>({id:e.name||t,originalIndex:t,...e})),ee=l.useRef(null);(0,l.useEffect)(()=>{let e=setTimeout(()=>{ee.current&&I(!0)},200);return()=>clearTimeout(e)},[ee]);let et=()=>{let e=ee.current;if(!e||!H)return[];try{let t=e.getSelectedRows();return t?Array.from(t.values()):[]}catch(e){return console.warn("Failed to get selected items:",e),[]}},en=(0,l.useCallback)(()=>{if(!N.current||!H)return;let e=et();if(N.current.innerHTML="",0===e.length)return;console.log("selectedItems:",e);let t=e.map(e=>{var t;let n=J(e,null!=(t=e.originalIndex)?t:0);return{question_no:n.question_no,question_text:n.question_text}}),r=document.createElement("harmony-export");r.size="32px",r.instrument_name="".concat(n||"Selected Variables"," from harmonydata.ac.uk/discover"),r.questions=t,N.current.appendChild(r)},[H,n]);(0,l.useEffect)(()=>{if(!H||!ee.current)return;let e=ee.current.subscribeEvent("rowSelectionChange",()=>{en()});return()=>{e()}},[H,en]);let er=()=>{null==O||O()},el=()=>{let e,t=ee.current;if(!t||!H)return[];try{e=t.getSelectedRows()}catch(t){e=null}return(e&&"number"==typeof e.size&&e.size>0&&e?Array.from(e.values()):(()=>{let e;try{e=t.getRowModels()}catch(t){e=null}return e?Array.from(e.values()):[]})()).map(e=>{var t;let n=J(e,null!=(t=e.originalIndex)?t:0),r={question_no:n.question_no,question_text:n.question_text};return Z&&(r.response_options=n.response_options),r})},eo=async()=>{let e=el();await new Promise((e,t)=>{if(window.XLSX)return void e();let n=document.querySelector('script[src="/js/xlsx.min.js"]');if(n){n.addEventListener("load",()=>e()),n.addEventListener("error",t);return}let r=document.createElement("script");r.src="/js/xlsx.min.js",r.async=!0,r.onload=()=>e(),r.onerror=t,document.head.appendChild(r)});let t=window.XLSX||globalThis.XLSX;if(!t){console.error("XLSX library failed to load"),er();return}let n=t.utils.json_to_sheet(e),r=t.utils.book_new();t.utils.book_append_sheet(r,n,"Questions");let l=new Blob([t.write(r,{bookType:"xlsx",type:"array"})],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),o=URL.createObjectURL(l),i=document.createElement("a");i.href=o,i.download="questions.xlsx",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o),er()};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(u.default,{sx:{height:"100%",minHeight:400},children:($.length>0||P)&&(0,r.jsx)(o.z,{apiRef:ee,...P?{dataSource:P}:{rows:$},columns:Y,checkboxSelection:!0,sortModel:[],getRowClassName:e=>e.row.matched?"matched-row":"",filterMode:"client",sortingMode:"client",paginationMode:y?"server":"client",sx:{background:"white",borderRadius:2,fontSize:14,height:"100%","& .matched-row":{backgroundColor:"#fffae4","&:hover":{backgroundColor:"#fff8d1"}}},hideFooter:!y,pageSizeOptions:[20,50,100],pagination:!0,showToolbar:!0,initialState:G,slots:{toolbar:()=>(0,r.jsxs)(u.default,{sx:{display:"flex",alignItems:"center",gap:2,p:1,mr:2,flexWrap:"wrap"},children:[(0,r.jsx)(u.default,{sx:{flex:1,minWidth:200},children:(0,r.jsx)(i.e,{expanded:!0,style:{width:"100%"},children:(0,r.jsx)(s.X,{placeholder:"Search within variables",style:{background:"white",borderRadius:192,fontSize:14}})})}),(0,r.jsx)(c.A,{title:"Harmonise selected items",children:(0,r.jsx)(a.A,{size:"small",sx:{width:40,height:40},children:(0,r.jsx)(u.default,{ref:N,sx:{display:"flex",alignItems:"center",justifyContent:"center",width:20,height:20}})})}),(0,r.jsx)(c.A,{title:(()=>{let e=ee.current;if(!e||!H)return!1;try{let t=e.getSelectedRows();return t&&"number"==typeof t.size&&t.size>0}catch(e){return!1}})()?"Download ".concat(et().length," selected questions"):"Download all questions",children:(0,r.jsx)(a.A,{ref:D,size:"small",onClick:T,sx:{width:40,height:40},children:(0,r.jsx)(b.A,{size:30})})})]})}})}),(0,r.jsx)(d.Ay,{open:!!L,anchorEl:L,onClose:er,anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"center"},children:(0,r.jsxs)(h.A,{sx:{width:200},children:[(0,r.jsxs)(p.Ay,{onClick:()=>{let e=new Blob([JSON.stringify(el(),null,2)],{type:"application/json"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="questions.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),er()},sx:{cursor:"pointer"},children:[(0,r.jsx)(m.A,{children:(0,r.jsx)(k,{size:20})}),(0,r.jsx)(x.A,{primary:"Download as JSON"})]}),(0,r.jsxs)(p.Ay,{onClick:()=>{let e=new Blob([[Z?["Question Number","Question Text","Response Options"]:["Question Number","Question Text"],...el().map(e=>Z?[e.question_no,e.question_text,e.response_options]:[e.question_no,e.question_text])].map(e=>e.map(e=>'"'.concat(e,'"')).join(",")).join("\n")],{type:"text/csv"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="questions.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),er()},sx:{cursor:"pointer"},children:[(0,r.jsx)(m.A,{children:(0,r.jsx)(_.A,{size:20})}),(0,r.jsx)(x.A,{primary:"Download as CSV"})]}),(0,r.jsxs)(p.Ay,{onClick:eo,sx:{cursor:"pointer"},children:[(0,r.jsx)(m.A,{children:(0,r.jsx)(A,{size:20})}),(0,r.jsx)(x.A,{primary:"Download as Excel"})]})]})})]})}function L(e){let{variables:t,studyName:n,studyUuid:o,studyAncestors:i,query:s,variablesWhichMatched:d,alpha:h,maxVectorDistance:p,maxDistanceMode:m,directMatchWeight:x,onTotalCountChange:w,onShouldHideTable:b}=e,[j,k]=(0,l.useState)(!1),_=(0,l.useRef)(null),[A,z]=(0,l.useState)(null),M=()=>{z(null),k(!1)},S=(0,r.jsx)(E,{variables:t,studyName:n,studyUuid:o,studyAncestors:i,query:s,variablesWhichMatched:d,alpha:h,maxVectorDistance:p,maxDistanceMode:m,directMatchWeight:x,onTotalCountChange:w,onShouldHideTable:b,downloadAnchorEl:A,onDownloadClick:e=>{console.log("handleDownloadClick",e.currentTarget),z(_.current)},onDownloadClose:()=>{z(null)}});return j?(0,r.jsxs)(y.A,{ref:_,open:!0,onClose:M,maxWidth:"xl",fullWidth:!0,sx:{"& .MuiDialog-paper":{height:"90vh",maxHeight:"90vh"}},children:[(0,r.jsxs)(g.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pb:1},children:[(0,r.jsxs)(f.A,{variant:"h6",children:["Variables - ",n||"Study"]}),(0,r.jsx)(a.A,{onClick:M,size:"small",sx:{color:"text.secondary"},children:(0,r.jsx)(C,{size:20})})]}),(0,r.jsx)(v.A,{sx:{p:0,overflow:"hidden"},children:(0,r.jsx)(u.default,{sx:{height:"100%","& .MuiDataGrid-root":{borderRadius:0,maxHeight:"none",height:"100%"}},children:S})})]}):(0,r.jsxs)(u.default,{ref:_,sx:{position:"relative"},children:[(0,r.jsx)(u.default,{sx:{position:"absolute",top:8,right:8,zIndex:10,backgroundColor:"rgba(255, 255, 255, 0.9)",borderRadius:1},children:(0,r.jsx)(c.A,{title:"Open in large view",children:(0,r.jsx)(a.A,{size:"small",onClick:()=>{z(null),k(!0)},children:(0,r.jsx)(q,{size:20})})})}),(0,r.jsx)(u.default,{sx:{"& .MuiDataGrid-root":{height:450,borderRadius:2}},children:S})]})}n(8325)},53489:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});let r=(0,n(14294).A)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]])}}]);