"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4684],{84684:(e,t,l)=>{l.r(t),l.d(t,{default:()=>ee});var s=l(95155),i=l(12115),r=l(35761),a=l(55295),n=l(68998),o=l(9552),d=l(9561),c=l(70152),u=l(22282),h=l(47821),x=l(19579),g=l(6327),m=l(72107),f=l(5565),y=l(10979),v=l(98245);function p(e){let{results:t,resourceTypeFilter:l,onSelectResult:i,selectedResultId:r,onFindSimilar:a,collapsed:o=!1,hasActiveSearch:c=!1}=e,u=l&&l.length>0?t.filter(e=>{var t,s;return(null===(t=e.extra_data)||void 0===t?void 0:t.resource_type)&&l.map(e=>e.trim().toLowerCase()).includes(null===(s=e.extra_data)||void 0===s?void 0:s.resource_type.trim().toLowerCase())}):t;console.log("SearchResults debug:",{resourceTypeFilter:l,originalResults:t,filteredResults:u});let h=e=>{i&&i(e)};return u.length?(0,s.jsx)(n.default,{children:(0,s.jsx)(y.A,{spacing:1.5,sx:{mb:4},children:u.map((e,t)=>{var l,i;let n=r===(null===(l=e.extra_data)||void 0===l?void 0:l.uuid);return(0,s.jsx)(v.A,{result:e,isSelected:n,onClick:()=>h(e),onFindSimilar:a},(null===(i=e.extra_data)||void 0===i?void 0:i.uuid)||"result-".concat(t))})})}):(0,s.jsx)(n.default,{sx:{textAlign:"center",py:8,maxWidth:600,mx:"auto"},children:c?(0,s.jsxs)(n.default,{children:[(0,s.jsx)(d.A,{variant:"h5",color:"text.primary",gutterBottom:!0,children:"No results found"}),(0,s.jsx)(d.A,{variant:"body1",color:"text.secondary",gutterBottom:!0,children:"We couldn't find any studies matching your search criteria."}),(0,s.jsx)(d.A,{variant:"body2",color:"text.secondary",children:"Try adjusting your search terms, removing some filters, or broadening your criteria to find more results."})]}):(0,s.jsxs)(n.default,{children:[(0,s.jsx)(d.A,{variant:"h5",color:"text.primary",gutterBottom:!0,children:"Harmony Search is here to help you find existing research studies in the UK"}),(0,s.jsx)(d.A,{variant:"body1",color:"text.secondary",children:"Start by entering keywords in the search box above or browse our collection of research studies and datasets."})]})})}var b=l(14030),j=l(77626),_=l(72926),A=l(70424),w=l(66917),S=l(48139),C=l(30762);function k(e){let{onSubmitFeedback:t}=e,[l,r]=(0,i.useState)(null),[a,o]=(0,i.useState)(null),[x,m]=(0,i.useState)(""),[f,v]=(0,i.useState)(!1),p=()=>{r(null),o(null),m("")},b=async()=>{if(a){v(!0);try{await (null==t?void 0:t(a,x)),p()}catch(e){console.error("Error submitting feedback:",e)}finally{v(!1)}}};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(_.A,{title:"Give feedback",placement:"left",children:(0,s.jsx)(A.A,{color:"primary",size:"small",onClick:e=>{r(e.currentTarget)},sx:{position:"fixed",bottom:0,right:0,zIndex:1e3,boxShadow:3,borderRadius:"4px 0 0 0"},children:(0,s.jsx)(C.A,{})})}),(0,s.jsx)(w.Ay,{open:!!l,anchorEl:l,onClose:p,anchorOrigin:{vertical:"center",horizontal:"left"},transformOrigin:{vertical:"center",horizontal:"right"},sx:{"& .MuiPopover-paper":{borderRadius:2,boxShadow:3}},children:(0,s.jsxs)(n.default,{sx:{p:3,minWidth:300},children:[(0,s.jsxs)(n.default,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[(0,s.jsx)(d.A,{variant:"h6",component:"h2",children:"Share your feedback"}),(0,s.jsx)(h.A,{size:"small",onClick:p,children:(0,s.jsx)(g.A,{})})]}),(0,s.jsxs)(y.A,{spacing:2,children:[(0,s.jsxs)(n.default,{children:[(0,s.jsx)(d.A,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"How would you rate your experience?"}),(0,s.jsx)(S.A,{name:"feedback-rating",value:a,onChange:(e,t)=>{o(t)},size:"large"})]}),(0,s.jsx)(c.A,{multiline:!0,rows:3,placeholder:"Tell us what you think... (optional)",value:x,onChange:e=>m(e.target.value),variant:"outlined",size:"small",fullWidth:!0}),(0,s.jsxs)(n.default,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:[(0,s.jsx)(u.A,{size:"small",onClick:p,children:"Cancel"}),(0,s.jsx)(u.A,{variant:"contained",size:"small",onClick:b,disabled:!a||f,children:f?"Submitting...":"Submit"})]})]})]})})]})}var F=l(42649);let E=null,D=async()=>{if(E)return E;console.log("\uD83D\uDD0D Loading Firebase modules dynamically for feedback");let[{db:e},{collection:t,addDoc:s,serverTimestamp:i}]=await Promise.all([Promise.resolve().then(l.bind(l,73179)),Promise.resolve().then(l.bind(l,54615))]);return E={db:e,collection:t,addDoc:s,serverTimestamp:i}},I=async(e,t)=>{try{let{db:l,collection:s,addDoc:i,serverTimestamp:r}=await D(),a={uid:"anon",rating:e,comment:t||"",created:r(),source:"discoverynext"},n=await i(s(l,"ratings"),a);return console.log("Feedback submitted with ID: ",n.id),n}catch(e){throw console.error("Error submitting feedback:",e),e}};var R=l(17146),z=l(63612),P=l(54615),T=l(73179),W=l(20687),q=l(76046),L=l(1234),M=l(64517),O=l(9450),B=l(41983),N=l(22783),H=l(25012),U=l(15325),K=l(79201),V=l(99489),J=l(96588),Y=l(63219),G=l(89026);function Q(e){let{useSearch2:t,onEndpointChange:l,hybridWeight:r,onHybridWeightChange:a,maxDistance:o,onMaxDistanceChange:c}=e,[h,x]=(0,i.useState)(null),g=(0,i.useRef)(null),[m,f]=(0,i.useState)(null),[y,v]=(0,i.useState)(!0),p=!!h;return(0,i.useEffect)(()=>{(async()=>{try{let e=await (0,F.Pn)();f(e)}catch(e){console.error("Failed to fetch version info:",e),f({harmony_discovery_version:"Unknown"})}finally{v(!1)}})()},[]),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.default,{sx:{display:"flex",alignItems:"center",gap:2},children:[(0,s.jsx)(u.A,{ref:g,variant:"contained",color:"secondary",onClick:()=>{x(g.current)},sx:{minWidth:0,width:40,height:40,borderRadius:"50%",p:0},children:p?(0,s.jsx)(G.A,{}):(0,s.jsx)(Y.A,{})}),(0,s.jsx)(d.A,{sx:{color:"#191B22",fontWeight:500,whiteSpace:"nowrap"},children:"Advanced Search"})]}),(0,s.jsx)(w.Ay,{open:p,anchorEl:h,onClose:()=>{x(null)},anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},sx:{mt:1},children:(0,s.jsxs)(n.default,{sx:{p:3,minWidth:280},children:[(0,s.jsx)(d.A,{variant:"h6",gutterBottom:!0,children:"Search Configuration"}),(0,s.jsx)(n.default,{sx:{mb:3},children:(0,s.jsx)(K.A,{control:(0,s.jsx)(V.A,{checked:t,onChange:e=>{l(e.target.checked)},color:"primary"}),label:(0,s.jsxs)(n.default,{children:[(0,s.jsx)(d.A,{variant:"body2",fontWeight:500,children:"Search Version"}),(0,s.jsx)(d.A,{variant:"caption",color:"text.secondary",children:t?"Previous Version":y?"Loading...":(null==m?void 0:m.harmony_discovery_version)||"Current Version"})]})})}),(0,s.jsxs)(n.default,{sx:{mb:2},children:[(0,s.jsxs)(d.A,{variant:"body2",fontWeight:500,gutterBottom:!0,children:["Hybrid Weight: ",r.toFixed(2)]}),(0,s.jsx)(d.A,{variant:"caption",color:"text.secondary",gutterBottom:!0,display:"block",children:"Controls the balance between semantic and keyword search"}),(0,s.jsx)(n.default,{sx:{px:2,mt:2},children:(0,s.jsx)(J.Ay,{value:r,onChange:(e,t)=>{a(t)},min:0,max:1,step:.01,valueLabelDisplay:"auto",valueLabelFormat:e=>e.toFixed(2),marks:[{value:0,label:"Keyword"},{value:.5,label:"Balanced"},{value:1,label:"Semantic"}]})})]}),(0,s.jsxs)(n.default,{sx:{mb:2},children:[(0,s.jsxs)(d.A,{variant:"body2",fontWeight:500,gutterBottom:!0,children:["Max Distance: ",o.toFixed(2)]}),(0,s.jsx)(d.A,{variant:"caption",color:"text.secondary",gutterBottom:!0,display:"block",children:"Controls the maximum vector distance for semantic search results"}),(0,s.jsx)(n.default,{sx:{px:2,mt:2},children:(0,s.jsx)(J.Ay,{value:o,onChange:(e,t)=>{c(t)},min:0,max:1,step:.01,valueLabelDisplay:"auto",valueLabelFormat:e=>e.toFixed(2),marks:[{value:0,label:"0"},{value:.4,label:"0.4"},{value:1,label:"1"}]})})]}),(0,s.jsx)(n.default,{sx:{mt:3,p:2,bgcolor:"grey.50",borderRadius:1},children:(0,s.jsxs)(d.A,{variant:"caption",color:"text.secondary",children:[(0,s.jsx)("strong",{children:"Tip:"})," Hybrid weight is automatically adjusted based on query length. Short queries favor keyword search (lower values), while longer queries favor semantic search (higher values)."]})})]})})]})}var X=l(3485),$=l(71900);function Z(){var e,t,l,y,v,_,A;let w=(0,r.A)(),S=(0,a.A)(w.breakpoints.down("sm")),C=(0,a.A)(w.breakpoints.down("lg")),{searchSettings:E,updateSearchSettings:D}=(0,z.S)(),[K,V]=(0,i.useState)(E.query),[J,Y]=(0,i.useState)(E.query),[G,Z]=(0,i.useState)([]),[ee,et]=(0,i.useState)([]),[el,es]=(0,i.useState)(E.selectedCategory),[ei,er]=(0,i.useState)(!1),[ea,en]=(0,i.useState)(!0),[eo,ed]=(0,i.useState)(!1),[ec,eu]=(0,i.useState)(0),[eh,ex]=(0,i.useState)(1),[eg,em]=(0,i.useState)(null),[ef,ey]=(0,i.useState)(!1),[ev,ep]=(0,i.useState)(!1),[eb,ej]=(0,i.useState)(!1),[e_,eA]=(0,i.useState)(!1),[ew,eS]=(0,i.useState)(null),[eC,ek]=(0,i.useState)(E.useSearch2),[eF,eE]=(0,i.useState)(E.hybridWeight),[eD,eI]=(0,i.useState)(E.hybridWeight),[eR,ez]=(0,i.useState)(E.maxDistance),[eP,eT]=(0,i.useState)(E.maxDistance),[eW,eq]=(0,i.useState)(null),[eL,eM]=(0,i.useState)(null),[eO,eB]=(0,i.useState)([]),[eN,eH]=(0,i.useState)(void 0),[eU,eK]=(0,i.useState)([]),[eV,eJ]=(0,i.useState)(!1),[eY,eG]=(0,i.useState)(!1),[eQ,eX]=(0,i.useState)(!1),[e$,eZ]=(0,i.useState)(!1),{currentUser:e0}=(0,R.A)();(0,i.useEffect)(()=>{D({query:K,selectedFilters:E.selectedFilters,selectedCategory:el,useSearch2:eC,hybridWeight:eF,maxDistance:eR})},[K,E.selectedFilters,el,eC,eF,eR,D]),(0,i.useEffect)(()=>{eX(!1)},[K,E.selectedFilters,eC,eF,eR,el]),(0,i.useEffect)(()=>{let e=E.query&&""!==E.query.trim(),t=Object.keys(E.selectedFilters).length>0;!e$&&(e||t)&&(eZ(!0),t_(E.query||"",1))},[E,e$,t_]),(0,i.useEffect)(()=>{eZ(!1)},[]);let e1=(0,q.useSearchParams)(),e2=e1.get("resource_type"),e5=e1.get("like"),e4=e1.get("query"),e6=e1.getAll("topics"),e3=e1.getAll("instruments"),e8=e1.getAll("study_design");(0,i.useEffect)(()=>{if(e4||e6.length>0||e3.length>0||e8.length>0){let e={};e6.length>0&&(e.keywords=e6),e3.length>0&&(e.instruments=e3),e8.length>0&&(e.study_design=e8),e2&&(e.resource_type=[e2]),D({query:e4||"",selectedFilters:e,selectedCategory:null,resourceType:e2,similarUid:e5})}},[]);let e9=(0,q.useRouter)();(0,i.useEffect)(()=>{let e=!1;if(e4&&(V(e4),Y(e4),e=!0),e6&&e6.length>0&&(!E.selectedFilters.keywords||E.selectedFilters.keywords.join(",")!==e6.join(","))&&(D({...E,selectedFilters:{...E.selectedFilters,keywords:e6}}),e=!0),e3&&e3.length>0&&(!E.selectedFilters.instruments||E.selectedFilters.instruments.join(",")!==e3.join(","))&&(D({...E,selectedFilters:{...E.selectedFilters,instruments:e3}}),e=!0),e8&&e8.length>0&&(!E.selectedFilters.study_design||E.selectedFilters.study_design.join(",")!==e8.join(","))&&(D({...E,selectedFilters:{...E.selectedFilters,study_design:e8}}),e=!0),e){let e=new URL(window.location.href);e.searchParams.delete("query"),e.searchParams.delete("topics"),e.searchParams.delete("instruments"),e.searchParams.delete("study_design");let t=e.pathname.replace("/search","");console.log("Navigating to:",t+e.search),e9.replace(t+e.search)}},[e4,e6,e3,e8]);let e7=(0,i.useMemo)(()=>e2?[e2]:[],[e2]),te=(0,i.useRef)(J),tt=(0,i.useRef)(JSON.stringify(E.selectedFilters)),tl=(0,i.useRef)(eC),ts=(0,i.useRef)(eD),ti=(0,i.useRef)(eP),tr=(0,i.useRef)(eO);(0,i.useRef)(!1);let ta=(0,i.useRef)([]),tn=(0,i.useRef)(void 0),to=(0,i.useCallback)(e=>{if(!e||""===e.trim()||"*"===e)return .5;let t=e.trim();return eU.some(e=>t.toLowerCase()===e.toLowerCase())?0:.5},[eU]),td=(0,i.useCallback)(e=>{ek(e)},[]),tc=(0,i.useCallback)(e=>{eE(e)},[]),tu=(0,i.useCallback)(e=>{ez(e)},[]);(0,i.useEffect)(()=>{let e=to(J);eE(e),eI(e)},[J,to]),(0,i.useEffect)(()=>{let e=setTimeout(()=>{Y(K)},500);return()=>{clearTimeout(e)}},[K]),(0,i.useEffect)(()=>{let e=setTimeout(()=>{eI(eF)},300);return()=>{clearTimeout(e)}},[eF]),(0,i.useEffect)(()=>{let e=setTimeout(()=>{eT(eR)},300);return()=>{clearTimeout(e)}},[eR]),(0,i.useEffect)(()=>{(async()=>{if(!eV)try{let e=await (0,F.Qf)();eK(e),eJ(!0)}catch(e){console.error("Failed to fetch keyword phrases:",e),eJ(!0)}})()},[eV]);let th=(0,i.useCallback)(e=>{em(e),S?ey(!0):ej(!0)},[S]),tx=(0,i.useCallback)(e=>{console.log("Selected result:",e),th(e)},[th]),tg=(0,i.useCallback)(()=>{ey(!1)},[]),tm=(0,i.useCallback)(()=>{!S&&eg&&ej(!0)},[S,eg]),tf=(0,i.useCallback)(()=>{S||ej(e=>!e)},[S]);(0,i.useEffect)(()=>{(async function(){try{console.log("Fetching initial aggregations..."),er(!0),eA(!1);let e=new Promise((e,t)=>{setTimeout(()=>t(Error("API request timed out")),6e4)}),t=await Promise.race([(0,F.Dd)(),e]),l=tw(t);et(l),console.log("Initial aggregations set:",l.length,"filters"),er(!1)}catch(e){console.error("Failed to fetch initial aggregations:",e),eA(!0),er(!1)}})()},[]),(0,i.useEffect)(()=>{G.length>0&&!eg?em(G[0]):G.length>0&&eg?G.some(e=>{var t,l;return(null===(t=e.extra_data)||void 0===t?void 0:t.uuid)===(null===(l=eg.extra_data)||void 0===l?void 0:l.uuid)})||em(G[0]):0===G.length&&em(null)},[G,eg]),(0,i.useEffect)(()=>{ep(!1)},[eg]);let ty=(0,i.useCallback)(e=>{var t,l,s;let i=null===(l=e.extra_data)||void 0===l?void 0:null===(t=l.resource_type)||void 0===t?void 0:t.includes("variable"),r=Array.isArray(e.ancestors)&&e.ancestors.length>0;return i&&r&&(null===(s=e.ancestors)||void 0===s?void 0:s[0])||e},[]),tv=async()=>{if(e0&&K.trim()&&!eY){eG(!0),eX(!1);try{let e={query:K,filters:E.selectedFilters,useSearch2:eC,hybridWeight:eF,maxDistance:eR,selectedCategory:el,resultCount:G.length,uid:e0.uid,created:(0,P.serverTimestamp)()};console.log("Saving search:",e,T.db),await (0,P.addDoc)((0,P.collection)(T.db,"saved_searches"),e),eX(!0)}catch(e){console.error("Error saving search:",e)}finally{eG(!1)}}},[tp,tb]=(0,i.useState)(null);(0,i.useEffect)(()=>{if(!eg){tb(null);return}tb(ty(eg))},[eg,ty]),(0,i.useEffect)(()=>{(async function(){if(e5)try{var e,t;er(!0);let l=await (0,F.w3)(e5,void 0,void 0,eP);eS(l);let s=(null===(e=l.dataset_schema)||void 0===e?void 0:e.description)||(null===(t=l.extra_data)||void 0===t?void 0:t.description);if(!s)throw Error("No description available for similar search");V(s),Y(s);let i=to(s),r=await (0,F.Hu)(s,{},1,50,eC,i,void 0,void 0,void 0,eP);Z(r.results||[]),eu(r.num_hits||0)}catch(e){console.error("Failed to load similar studies:",e),eA(!0)}finally{er(!1)}})()},[e5,50,eC,eD]),(0,i.useEffect)(()=>{var e,t;let l=J!==te.current||JSON.stringify(E.selectedFilters)!==tt.current||eC!==tl.current||eD!==ts.current||eP!==ti.current,s=e5&&((null==ew?void 0:null===(e=ew.dataset_schema)||void 0===e?void 0:e.description)||(null==ew?void 0:null===(t=ew.extra_data)||void 0===t?void 0:t.description))||J;l&&(console.log("\uD83D\uDD0D Search parameters changed, clearing results and resetting to page 1"),Z([]),eB([]),ta.current=[],eH(void 0),tn.current=void 0,1!==eh&&ex(1),t_(s,1).finally(()=>{te.current=J,tt.current=JSON.stringify(E.selectedFilters),tl.current=eC,ts.current=eD,ti.current=eP,tr.current=eO}))},[J,E.selectedFilters,e5,ew,eC,eD,eP]),(0,i.useEffect)(()=>{if(eh>1){var e,t;console.log("\uD83D\uDCC4 Page changed to:",eh,"- loading more results"),t_(e5&&((null==ew?void 0:null===(e=ew.dataset_schema)||void 0===e?void 0:e.description)||(null==ew?void 0:null===(t=ew.extra_data)||void 0===t?void 0:t.description))||J,eh)}},[eh]);let tj=(0,i.useCallback)(async()=>{if(console.log("\uD83D\uDD04 loadMore called:",{loadingMore:eo,hasMoreResults:ea,currentPage:eh,resultsLength:G.length}),eo||!ea){console.log("\uD83D\uDD04 loadMore early return:",{loadingMore:eo,hasMoreResults:ea});return}let e=eh+1;console.log("\uD83D\uDD04 loadMore proceeding to page:",e),ex(e)},[eo,ea,eh]);async function t_(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:J,t=arguments.length>1?arguments[1]:void 0,l=void 0!==t?t:eh;1===l?er(!0):ed(!0),eA(!1);let s=Date.now();1===l&&(en(!0),ed(!1));try{var i,r;let t;let a={...E.selectedFilters};e2&&(a.resource_type=[e2]),Object.keys(a).forEach(e=>{Array.isArray(a[e])&&0===a[e].length&&delete a[e]});let n="search-".concat(Date.now());console.group("\uD83D\uDD0D Search Request: ".concat(n)),console.log("Search query:",e||"(empty)"),console.log("Filters:",a),console.log("Page:",l),console.log("Results per page:",50),console.log("Use Search2:",eC),console.log("Similar UID (will be excluded):",e5||"None"),console.log("Top Level IDs Seen:",l>1?eO:"First page");let o=new Promise((e,t)=>{setTimeout(()=>t(Error("API request timed out")),6e4)}),d=Date.now();l>1?t=ta.current:e5&&(t=[e5],console.log("Excluding original study from similar search:",e5));let c=to(e),u=await Promise.race([(0,F.Hu)(e,a,l,50,eC,c,t,l>1?tn.current:void 0,void 0,eP),o]),h=Date.now()-d;eM(h),console.log("Response received:",{requestId:n,numHits:u.num_hits,resultCount:(null===(i=u.results)||void 0===i?void 0:i.length)||0,apiTime:"".concat(h,"ms"),results:null===(r=u.results)||void 0===r?void 0:r.map(e=>{var t,l,s,i;return{id:null===(t=e.extra_data)||void 0===t?void 0:t.uuid,title:null===(l=e.dataset_schema)||void 0===l?void 0:l.name,type:(null===(s=e.extra_data)||void 0===s?void 0:s.resource_type)||(null===(i=e.dataset_schema)||void 0===i?void 0:i["@type"]),similarity:e.cosine_similarity}}),timestamp:new Date().toISOString()}),console.groupEnd();let x=u.results||[];if(u.top_level_ids_seen_so_far?(console.log("Received top_level_ids_seen_so_far:",{count:u.top_level_ids_seen_so_far.length,sample:u.top_level_ids_seen_so_far.slice(0,5),previousCount:eO.length}),eB(u.top_level_ids_seen_so_far),ta.current=u.top_level_ids_seen_so_far):console.log("No top_level_ids_seen_so_far in response"),void 0!==u.next_page_offset?(console.log("Received next_page_offset:",{offset:u.next_page_offset,previousOffset:tn.current}),eH(u.next_page_offset),tn.current=u.next_page_offset):console.log("No next_page_offset in response (using calculated offset)"),1===l){if(Z(x),eu(u.num_hits||0),eC)en(50===x.length&&x.length<(u.num_hits||0));else{let e=x.length>0;en(e),(!e||x.length<50)&&eu(Math.max(u.num_hits||0,x.length)),x.length>0&&x.length<50&&x.length<20&&(console.log("\uD83D\uDD04 Auto-loading next page from first page - insufficient results:",{gotResults:x.length,requestedResults:50,minThreshold:20,nextPage:2}),setTimeout(()=>{!eo&&ea&&ex(2)},100))}}else if(Z(e=>{if(!eC&&x.length>0){let t;t=1===l?x.length:e.length+x.length,x.length<50&&t<20&&(console.log("\uD83D\uDD04 Auto-loading next page - insufficient results:",{gotResults:x.length,requestedResults:50,currentTotal:t,minThreshold:20,nextPage:l+1}),setTimeout(()=>{!eo&&ea&&ex(l+1)},100))}return[...e,...x]}),eC)en(50===x.length);else{let e=x.length>0;en(e),e||eu(Math.max(ec,G.length+x.filter(e=>!G.some(t=>{var l,s;return(null===(l=t.extra_data)||void 0===l?void 0:l.uuid)===(null===(s=e.extra_data)||void 0===s?void 0:s.uuid)})).length))}let g=Date.now();eq(g-s)}catch(e){console.error("Search failed:",e),eA(!0),eq(null),eM(null)}finally{er(!1),ed(!1)}}let tA=async(e,t)=>{if(e)try{await I(e,t),console.log("Feedback submitted successfully")}catch(e){console.error("Failed to submit feedback:",e)}},tw=e=>{let t=[],l=["sample_size","age_lower","age_upper","start_year","end_year","duration_years","num_sweeps"],s=1/0,i=-1/0;if(Object.entries(e).forEach(e=>{let[r,a]=e;if("age_lower"===r||"age_upper"===r||"age_min"===r||"age_max"===r){let e=a.statistics||{},t=e.minimum;"number"==typeof t&&isFinite(t)||(t=e.min);let l=e.maximum;"number"==typeof l&&isFinite(l)||(l=e.max),"number"==typeof t&&isFinite(t)&&(s=Math.min(s,t)),"number"==typeof l&&isFinite(l)&&(i=Math.max(i,l));return}if(l.includes(r)){let e,l;let s=a.statistics||{};"number"==typeof s.minimum&&isFinite(s.minimum)?e=s.minimum:"number"==typeof s.min&&isFinite(s.min)?e=s.min:(console.warn("Missing valid min value for ".concat(r,", using default")),e="sample_size"===r?0:"start_year"===r||"end_year"===r?1900:0),"number"==typeof s.maximum&&isFinite(s.maximum)?l=s.maximum:"number"==typeof s.max&&isFinite(s.max)?l=s.max:(console.warn("Missing valid max value for ".concat(r,", using default")),l="sample_size"===r?1e5:"start_year"===r||"end_year"===r?2024:"duration_years"===r?100:"num_sweeps"===r?50:100),l<=e&&(l=e+1);let i=Array.from({length:101},(t,s)=>String(e+s/100*(l-e)));t.push({id:r,label:r.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),type:"range",options:i})}else{let e=a.buckets||[];e.length>0&&t.push({id:r,label:r.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),type:"multiselect",options:e.map(e=>e.key||"")})}}),isFinite(s)&&isFinite(i)&&s<=i){i<=s&&(i=s+1);let e=Array.from({length:101},(e,t)=>String(s+t/100*(i-s)));t.push({id:"age_range",label:"Age Range",type:"range",options:e})}else{console.warn("Missing valid age range data, using defaults");let e=Array.from({length:101},(e,t)=>String(0+t/100*100));t.push({id:"age_range",label:"Age Range",type:"range",options:e})}return t},tS=(0,i.useCallback)(async e=>{var t,l,s,i,r;let a=null===(t=e.extra_data)||void 0===t?void 0:t.uuid;if(!a)return;let n=(null===(l=e.dataset_schema)||void 0===l?void 0:l.name)||(null===(s=e.extra_data)||void 0===s?void 0:s.name)||"Unnamed Study";V("LIKE:".concat(n," (").concat(a,")"));let o=(null===(i=e.dataset_schema)||void 0===i?void 0:i.description)||(null===(r=e.extra_data)||void 0===r?void 0:r.description);o?(Y(o),tC(o)):(console.warn("No description available for study ".concat(n,", using name for similar search")),Y(n),tC(n))},[]),tC=async e=>{er(!0),eA(!1);try{let t;let l={...E.selectedFilters};e2&&(l.resource_type=[e2]),Object.keys(l).forEach(e=>{Array.isArray(l[e])&&0===l[e].length&&delete l[e]});let s=e,i=e.match(/^LIKE:(.*?)\s*\(([^)]+)\)$/);i&&(t=i[2],s="LIKE:".concat(t));let r=to(s),a=await (0,F.Hu)(s,l,eh,50,eC,r,t?[t]:eh>1?ta.current:void 0,eh>1?tn.current:void 0,void 0,eP);Z(a.results||[]),eu(a.num_hits||0)}catch(e){eA(!0)}finally{er(!1)}};return(0,s.jsxs)(n.default,{sx:{height:"100vh",overflow:"hidden",display:"flex",flexDirection:"column"},children:[(0,s.jsxs)(o.A,{maxWidth:"xl",sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",py:{xs:2,sm:3,md:4}},children:[(0,s.jsx)(n.default,{sx:{display:"flex",alignItems:"center",gap:3,mb:{xs:2,sm:3,md:4}},children:e5?(0,s.jsxs)(n.default,{sx:{display:"flex",alignItems:"center",gap:3,width:"100%",p:3,bgcolor:"background.paper",borderRadius:2,boxShadow:1},children:[(0,s.jsx)(n.default,{sx:{width:120,height:120,display:"flex",alignItems:"center",justifyContent:"center",color:"grey.500"},children:(null==ew?void 0:null===(e=ew.dataset_schema)||void 0===e?void 0:e.image)?(0,s.jsx)(f.default,{src:(null==ew?void 0:ew.dataset_schema).image,alt:(null==ew?void 0:null===(t=ew.dataset_schema)||void 0===t?void 0:t.name)||"Study",width:100,height:100,style:{objectFit:"contain"},unoptimized:!0}):(e=>{var t,l;let i=(null==e?void 0:null===(t=e.extra_data)||void 0===t?void 0:t.resource_type)||(null==e?void 0:null===(l=e.dataset_schema)||void 0===l?void 0:l["@type"]);return(null==i?void 0:i.includes("dataset"))?(0,s.jsx)(L.A,{size:48}):(null==i?void 0:i.includes("variable"))?(0,s.jsx)(M.A,{size:48}):(null==i?void 0:i.includes("study"))?(0,s.jsx)(O.A,{size:48}):(0,s.jsx)(B.A,{size:48})})(ew)}),(0,s.jsxs)(n.default,{children:[(0,s.jsx)(d.A,{variant:"h4",gutterBottom:!0,children:(null==ew?void 0:null===(l=ew.dataset_schema)||void 0===l?void 0:l.name)||(null==ew?void 0:null===(y=ew.extra_data)||void 0===y?void 0:y.name)||"Unnamed Study"}),(0,s.jsx)(d.A,{variant:"subtitle1",color:"text.secondary",children:"Similar Studies"})]})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(c.A,{fullWidth:!0,placeholder:"What are you searching for?",value:K,onChange:e=>{V(e.target.value)},InputProps:{endAdornment:(0,s.jsxs)(n.default,{sx:{mr:1,ml:-.5,display:"flex",alignItems:"center",gap:1},children:[K!==J&&(0,s.jsx)(d.A,{variant:"caption",color:"text.secondary",sx:{fontSize:{xs:"0.6rem",sm:"0.7rem"}},children:"Typing..."}),(0,s.jsx)(f.default,{src:(0,X.xC)()+"icons/discover.svg",alt:"Search",width:20,height:20})]}),sx:{height:48,"& .MuiOutlinedInput-root":{borderRadius:24},"& .MuiOutlinedInput-notchedOutline":{borderColor:"grey.200"}}},sx:{"& .MuiOutlinedInput-root":{borderRadius:24}}}),(0,s.jsx)(n.default,{sx:{display:"flex",alignItems:"center",gap:2},children:(0,s.jsx)(Q,{useSearch2:eC,onEndpointChange:td,hybridWeight:eF,onHybridWeightChange:tc,maxDistance:eR,onMaxDistanceChange:tu})})]})}),(0,s.jsx)(b.A,{filtersData:ee,onSelectionChange:(e,t)=>{D({selectedFilters:{...E.selectedFilters,[e]:t}})},selectedFilters:E.selectedFilters}),!e_&&(0,s.jsxs)(n.default,{sx:{mb:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,s.jsxs)(d.A,{variant:"body2",color:"text.secondary",children:[ei?"Searching...":ea?G.length>ec?"".concat(G.length," results loaded (").concat(ec,"+ estimated)"):ec>0?"".concat(G.length," of ~").concat(ec," results loaded"):"".concat(G.length," results loaded"):"".concat(G.length," results found"),!ei&&eL&&" (API: ".concat(eL,"ms"),!ei&&eW&&eL&&", Total: ".concat(eW,"ms)")]}),e0&&(0,s.jsx)(u.A,{variant:"outlined",size:"small",startIcon:eQ?(0,s.jsx)(W.A,{size:16,fill:"currentColor"}):(0,s.jsx)(W.A,{size:16}),onClick:tv,disabled:eY||!K.trim()||ei,sx:{ml:2,color:eQ?"success.main":"inherit",borderColor:eQ?"success.main":"inherit"},title:"Save this search",children:eY?"Saving...":eQ?"Saved!":"Save Search"})]}),(0,s.jsxs)(n.default,{sx:{display:S?"block":"flex",width:"100%",flex:1,minHeight:0,overflow:"visible",position:"relative"},children:[(0,s.jsx)(n.default,{sx:{width:C?"100%":"50%",minWidth:S?"100%":"300px",overflowX:"hidden",display:"flex",flexDirection:"column",height:"100%",position:"relative"},children:ei?(0,s.jsx)(d.A,{children:"Loading search results..."}):e_?(0,s.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",py:8,px:4,height:"100%"},children:[(0,s.jsx)(m.A,{sx:{fontSize:{xs:48,sm:64},color:"text.secondary",mb:2}}),(0,s.jsx)(d.A,{variant:"h5",color:"text.secondary",gutterBottom:!0,children:"The discovery API is currently offline"}),(0,s.jsx)(d.A,{color:"text.secondary",children:"Please try again soon. We apologize for the inconvenience."}),(0,s.jsx)(u.A,{variant:"contained",sx:{mt:4},onClick:()=>{eA(!1),t_()},children:"Retry Connection"})]}):(0,s.jsx)(s.Fragment,{children:(0,s.jsx)(n.default,{sx:{flex:1,overflowY:"auto",minHeight:0,display:"flex",flexDirection:"column"},id:"search-results-container",children:(0,s.jsx)($.A,{dataLength:G.length,next:tj,hasMore:ea,loader:!J&&(!E.selectedFilters||Object.values(E.selectedFilters).every(e=>0===e.length))?(0,s.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",py:6,textAlign:"center"},children:[(0,s.jsx)(d.A,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"Enter a search term or select some filters to begin"}),(0,s.jsx)(d.A,{variant:"body2",color:"text.secondary",children:"Use the search bar above or apply filters to discover studies"})]}):(0,s.jsx)(n.default,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:3},children:(0,s.jsx)(N.A,{size:24,className:"animate-spin",style:{color:"#1976d2"}})}),scrollableTarget:"search-results-container",endMessage:(0,s.jsx)(d.A,{children:"No more results to load."}),children:(0,s.jsx)(p,{results:G,resourceTypeFilter:e7,onSelectResult:tx,selectedResultId:null==eg?void 0:null===(v=eg.extra_data)||void 0===v?void 0:v.uuid,onFindSimilar:tS,hasActiveSearch:""!==E.query.trim()||Object.keys(E.selectedFilters).length>0||e7.length>0})})})})}),!S&&(G.length>0||ec>0)&&(0,s.jsxs)(n.default,{sx:{position:"absolute",top:0,right:0,width:eb?"calc(100% - 130px)":C?"0%":"50%",height:"100%",bgcolor:"background.paper",borderLeft:C&&!eb?"none":"1px solid",borderColor:"grey.200",display:"flex",flexDirection:"column",overflow:"visible",transition:"width 0.3s ease-in-out",cursor:eg?"pointer":"default",zIndex:eb?2:1,boxShadow:eb?"-4px 0 8px rgba(0, 0, 0, 0.1)":"none"},onClick:tm,children:[(0,s.jsx)(n.default,{sx:{position:"absolute",top:-16,left:-16,zIndex:1e3},children:(0,s.jsx)(h.A,{onClick:e=>{e.stopPropagation(),tf()},sx:{bgcolor:"primary.main",color:"white","&:hover":{bgcolor:"primary.dark"},boxShadow:2,width:30,height:30},children:eb?(0,s.jsx)(U.A,{size:20}):(0,s.jsx)(H.A,{size:20})})}),e_?(0,s.jsxs)(n.default,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",p:4,height:"100%"},children:[(0,s.jsx)(m.A,{sx:{fontSize:{xs:36,sm:48},color:"text.secondary",mb:2}}),(0,s.jsx)(d.A,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"API Offline"}),(0,s.jsx)(d.A,{variant:"body2",color:"text.secondary",children:"Study details unavailable"})]}):tp?(0,s.jsx)(n.default,{sx:{height:"100%",overflowY:"auto",minHeight:0},children:(0,s.jsx)(j.default,{study:tp,isDrawerView:!1})}):(0,s.jsx)(n.default,{sx:{display:"flex",height:"100%",alignItems:"center",justifyContent:"center",p:2},children:(0,s.jsx)(d.A,{color:"text.secondary",children:"Select a dataset to view details"})})]})]}),(0,s.jsxs)(x.Ay,{anchor:"right",open:S&&ef,onClose:tg,sx:{"& .MuiDrawer-paper":{width:{xs:"100%",sm:"80%",md:"60%"},maxWidth:"600px",p:0,overflow:"hidden",display:"flex",flexDirection:"column"}},children:[(0,s.jsxs)(n.default,{sx:{position:"sticky",top:0,zIndex:10,bgcolor:"background.paper",borderBottom:"1px solid",borderColor:"grey.200",p:1},children:[(0,s.jsx)(h.A,{onClick:tg,sx:{position:"absolute",top:8,right:8},children:(0,s.jsx)(g.A,{})}),(0,s.jsxs)(n.default,{sx:{py:1,pl:1,pr:6,display:"flex",alignItems:"center",gap:2},children:[(0,s.jsx)(d.A,{variant:"h6",sx:{flex:1},children:eg&&(null===(_=eg.dataset_schema)||void 0===_?void 0:_.name)||"Study Details"}),eg&&(eg.dataset_schema&&eg.dataset_schema.image||eg.image)&&!ev&&(0,s.jsx)(n.default,{sx:{width:50,height:50,position:"relative",borderRadius:"4px",overflow:"hidden",flexShrink:0},children:(0,s.jsx)(f.default,{src:eg.dataset_schema&&eg.dataset_schema.image||eg.image,alt:(null===(A=eg.dataset_schema)||void 0===A?void 0:A.name)||"Study image",fill:!0,style:{objectFit:"contain"},onError:()=>ep(!0),unoptimized:!0})})]})]}),(0,s.jsx)(n.default,{sx:{p:0,overflow:"hidden",display:"flex",flexDirection:"column",flex:1},children:tp?(0,s.jsx)(j.default,{studyDataComplete:!1,study:tp,isDrawerView:!0}):(0,s.jsx)(n.default,{sx:{display:"flex",height:"100%",alignItems:"center",justifyContent:"center",p:2},children:(0,s.jsx)(d.A,{color:"text.secondary",children:"Select a dataset to view details"})})})]})]}),(0,s.jsx)(k,{onSubmitFeedback:tA})]})}function ee(){return(0,s.jsx)(i.Suspense,{fallback:(0,s.jsx)(n.default,{sx:{p:4},children:(0,s.jsx)(d.A,{children:"Loading..."})}),children:(0,s.jsx)(Z,{})})}}}]);