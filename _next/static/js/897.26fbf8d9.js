(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[897],{5225:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});let r=(0,n(14294).A)("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]])},8325:()=>{},20897:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>E});var r=n(95155),o=n(12115),l=n(50077),i=n(17231),a=n(38912),s=n(94049),c=n(78470),u=n(1151),d=n(88538),h=n(41602),p=n(23820),m=n(49501),x=n(17681),y=n(2778),f=n(52363),g=n(25635),v=n(65036),j=n(14294);let w=(0,j.A)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]),b=(0,j.A)("FileJson",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 12a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1 1 1 0 0 1 1 1v1a1 1 0 0 0 1 1",key:"1oajmo"}],["path",{d:"M14 18a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1 1 1 0 0 1-1-1v-1a1 1 0 0 0-1-1",key:"mpwhp6"}]]);var k=n(5225);let _=(0,j.A)("Table",[["path",{d:"M12 3v18",key:"108xh3"}],["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}]]),C=(0,j.A)("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),q=(0,j.A)("Maximize2",[["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["polyline",{points:"9 21 3 21 3 15",key:"1avn1i"}],["line",{x1:"21",x2:"14",y1:"3",y2:"10",key:"ota7mn"}],["line",{x1:"3",x2:"10",y1:"21",y2:"14",key:"1atl0r"}]]);var A=n(75183);let z=!1,R=null,M=async()=>{if(!z)return R||(R=new Promise((e,t)=>{if(customElements.get("harmony-export")){console.log("\uD83D\uDD0D Harmony export component already registered"),z=!0,R=null,e();return}console.log("\uD83D\uDD0D Loading harmony-export web component");let n=document.createElement("script");n.src="/app/js/harmony-export.js",n.async=!0,n.onload=()=>{console.log("✅ Harmony export component loaded successfully"),z=!0,R=null,e()},n.onerror=e=>{console.error("❌ Failed to load harmony-export component:",e),R=null,t(e)},document.head.appendChild(n)}))};function S(e){let{variables:t,studyName:n,studyUuid:y,studyAncestors:f,query:g,variablesWhichMatched:v,alpha:j,maxVectorDistance:C,maxDistanceMode:q,directMatchWeight:z,onTotalCountChange:R,downloadAnchorEl:S,onDownloadClick:E,onDownloadClose:L}=e,O=(0,o.useRef)(null),D=(0,o.useRef)(null),[T,H]=(0,o.useState)(!1),[I,N]=(0,o.useState)(null),U=(0,o.useRef)(null),F=(0,o.useRef)(null),X=(0,o.useRef)(""),V=(0,o.useRef)(null),W=(0,o.useMemo)(()=>{if(g&&g.trim().length>0)return{filter:{filterModel:{items:[],quickFilterValues:[g.trim()]}}}},[g]),G=(0,o.useMemo)(()=>{if(y)return{getRows:async e=>{var t,n;let r=(null==(n=e.filterModel)||null==(t=n.quickFilterValues)?void 0:t[0])||"",o=e.paginationModel||{page:0,pageSize:50},l=r!==X.current,i=!V.current||o.page!==V.current.page||o.pageSize!==V.current.pageSize;if(X.current=r,V.current=o,l&&!i)return U.current&&clearTimeout(U.current),F.current&&F.current.reject(Error("Request cancelled by new filter")),new Promise((e,t)=>{F.current={resolve:e,reject:t},U.current=setTimeout(async()=>{var e,t;try{let t=await a();null==(e=F.current)||e.resolve(t),F.current=null}catch(e){null==(t=F.current)||t.reject(e),F.current=null}},500)});return a();async function a(){let e={ancestor_uuid:y,query:r&&r.trim()?r.trim():void 0,num_results:o.pageSize,offset:o.page*o.pageSize,alpha:j,max_vector_distance:C,max_distance_mode:q,direct_match_weight:z};try{let t,n=await (0,A.CO)(e),r=n.results||[],l=new Set;v&&v.length>0&&v.forEach(e=>{e.name&&l.add(e.name)});let i=new Map;r.forEach(e=>{let t=e.name||"unnamed";i.set(t,(i.get(t)||0)+1)});let a=r.map((e,t)=>{let n=e.name||"unnamed",r=i.get(n)||1,a=o.page*o.pageSize,s="".concat(n,"-").concat(a,"-").concat(t),c=r>1?"".concat(n," (x").concat(r,")"):n,u=l.has(n);return{...e,id:s,originalIndex:t,displayName:c,repeatCount:r,matched:u}}),s=o.page*o.pageSize;return void 0!==n.num_hits&&null!==n.num_hits?(t=n.num_hits,0===s&&I!==n.num_hits&&(N(n.num_hits),null==R||R(n.num_hits))):t=a.length<o.pageSize?s+a.length:null!==I?I:-1,{rows:a,rowCount:t}}catch(e){return console.error("Failed to fetch variables:",e),{rows:[],rowCount:0}}}}}},[y,j,C,q,z,v]);(0,o.useEffect)(()=>()=>{U.current&&clearTimeout(U.current),F.current&&F.current.reject(Error("Component unmounted"))},[]),(0,o.useEffect)(()=>{N(null),null==R||R(null)},[y,g,R]);let Q=y?[]:t||[];(0,o.useEffect)(()=>{M().catch(e=>{console.error("Failed to load harmony-export component:",e)})},[]);let B=(0,o.useCallback)((e,t)=>{let n=e.question&&e.question.trim().length>0,r=e.description&&e.description.trim().length>0,o=e.name&&e.name.trim().length>0,l=(n||r)&&o?e.name:t,i="";i=n&&r?e.question.trim()===e.description.trim()?e.question:"".concat(e.question," [").concat(e.description,"]"):n?e.question:r?e.description:o?e.name:"";let a=e.response_options||e.options;return{question_no:l,question_text:i,response_options:a&&Array.isArray(a)?a.join(" / "):""}},[]),J=[{field:"question_no",headerName:"Code",width:120,valueGetter:(e,t)=>{var n;return B(t,null!=(n=t.originalIndex)?n:0).question_no},sortable:!0},{field:"description",headerName:"Question / Variable name",flex:2,valueGetter:(e,t)=>{var n,r;return t.displayName&&t.repeatCount>1?B(t,null!=(n=t.originalIndex)?n:0).question_text||t.displayName:B(t,null!=(r=t.originalIndex)?r:0).question_text},sortable:!0},{field:"options",headerName:"Response Options",flex:1,valueGetter:(e,t)=>{var n;return B(t,null!=(n=t.originalIndex)?n:0).response_options},sortable:!0}],P=Q.filter(e=>e.name||e.description).map((e,t)=>({id:e.name||t,originalIndex:t,...e})),Z=o.useRef(null);(0,o.useEffect)(()=>{let e=setTimeout(()=>{Z.current&&H(!0)},200);return()=>clearTimeout(e)},[Z]);let K=()=>{let e=Z.current;if(!e||!T)return[];try{let t=e.getSelectedRows();return t?Array.from(t.values()):[]}catch(e){return console.warn("Failed to get selected items:",e),[]}},Y=(0,o.useCallback)(()=>{if(!O.current||!T)return;let e=K();if(O.current.innerHTML="",0===e.length)return;console.log("selectedItems:",e);let t=e.map(e=>{var t;let n=B(e,null!=(t=e.originalIndex)?t:0);return{question_no:n.question_no,question_text:n.question_text}}),r=document.createElement("harmony-export");r.size="32px",r.instrument_name="".concat(n||"Selected Variables"," from harmonydata.ac.uk/discover"),r.questions=t,O.current.appendChild(r)},[T,n]);(0,o.useEffect)(()=>{if(!T||!Z.current)return;let e=Z.current.subscribeEvent("rowSelectionChange",()=>{Y()});return()=>{e()}},[T,Y]);let $=()=>{null==L||L()},ee=()=>{let e,t=Z.current;if(!t||!T)return[];try{e=t.getSelectedRows()}catch(t){e=null}return(e&&"number"==typeof e.size&&e.size>0&&e?Array.from(e.values()):(()=>{let e;try{e=t.getRowModels()}catch(t){e=null}return e?Array.from(e.values()):[]})()).map(e=>{var t;let n=B(e,null!=(t=e.originalIndex)?t:0);return{question_no:n.question_no,question_text:n.question_text,response_options:n.response_options}})},et=async()=>{let e=ee();await new Promise((e,t)=>{if(window.XLSX)return void e();let n=document.querySelector('script[src="/js/xlsx.min.js"]');if(n){n.addEventListener("load",()=>e()),n.addEventListener("error",t);return}let r=document.createElement("script");r.src="/js/xlsx.min.js",r.async=!0,r.onload=()=>e(),r.onerror=t,document.head.appendChild(r)});let t=window.XLSX||globalThis.XLSX;if(!t){console.error("XLSX library failed to load"),$();return}let n=t.utils.json_to_sheet(e),r=t.utils.book_new();t.utils.book_append_sheet(r,n,"Questions");let o=new Blob([t.write(r,{bookType:"xlsx",type:"array"})],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),l=URL.createObjectURL(o),i=document.createElement("a");i.href=l,i.download="questions.xlsx",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(l),$()};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.default,{sx:{height:"100%",minHeight:400},children:(P.length>0||G)&&(0,r.jsx)(l.z,{apiRef:Z,...G?{dataSource:G}:{rows:P},columns:J,checkboxSelection:!0,sortModel:[{field:"score",sort:"desc"}],getRowClassName:e=>e.row.matched?"matched-row":"",filterMode:y?"server":"client",sortingMode:y?"server":"client",paginationMode:y?"server":"client",sx:{background:"white",borderRadius:2,fontSize:14,height:"100%","& .matched-row":{backgroundColor:"#fffae4","&:hover":{backgroundColor:"#fff8d1"}}},hideFooter:!y,pageSizeOptions:[20,50,100],pagination:!0,showToolbar:!0,initialState:W,slots:{toolbar:()=>(0,r.jsxs)(s.default,{sx:{display:"flex",alignItems:"center",gap:2,p:1,mr:2,flexWrap:"wrap"},children:[(0,r.jsx)(s.default,{sx:{flex:1,minWidth:200},children:(0,r.jsx)(i.e,{expanded:!0,style:{width:"100%"},children:(0,r.jsx)(a.X,{placeholder:"Search within variables",style:{background:"white",borderRadius:192,fontSize:14}})})}),(0,r.jsx)(c.A,{title:"Harmonise selected items",children:(0,r.jsx)(u.A,{size:"small",sx:{width:40,height:40},children:(0,r.jsx)(s.default,{ref:O,sx:{display:"flex",alignItems:"center",justifyContent:"center",width:20,height:20}})})}),(0,r.jsx)(c.A,{title:(()=>{let e=Z.current;if(!e||!T)return!1;try{let t=e.getSelectedRows();return t&&"number"==typeof t.size&&t.size>0}catch(e){return!1}})()?"Download ".concat(K().length," selected questions"):"Download all questions",children:(0,r.jsx)(u.A,{ref:D,size:"small",onClick:E,sx:{width:40,height:40},children:(0,r.jsx)(w,{size:30})})})]})}})}),(0,r.jsx)(d.Ay,{open:!!S,anchorEl:S,onClose:$,anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"center"},children:(0,r.jsxs)(h.A,{sx:{width:200},children:[(0,r.jsxs)(p.Ay,{onClick:()=>{let e=new Blob([JSON.stringify(ee(),null,2)],{type:"application/json"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="questions.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),$()},sx:{cursor:"pointer"},children:[(0,r.jsx)(m.A,{children:(0,r.jsx)(b,{size:20})}),(0,r.jsx)(x.A,{primary:"Download as JSON"})]}),(0,r.jsxs)(p.Ay,{onClick:()=>{let e=new Blob([[["Question Number","Question Text","Response Options"],...ee().map(e=>[e.question_no,e.question_text,e.response_options])].map(e=>e.map(e=>'"'.concat(e,'"')).join(",")).join("\n")],{type:"text/csv"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="questions.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),$()},sx:{cursor:"pointer"},children:[(0,r.jsx)(m.A,{children:(0,r.jsx)(k.A,{size:20})}),(0,r.jsx)(x.A,{primary:"Download as CSV"})]}),(0,r.jsxs)(p.Ay,{onClick:et,sx:{cursor:"pointer"},children:[(0,r.jsx)(m.A,{children:(0,r.jsx)(_,{size:20})}),(0,r.jsx)(x.A,{primary:"Download as Excel"})]})]})})]})}function E(e){let{variables:t,studyName:n,studyUuid:l,studyAncestors:i,query:a,variablesWhichMatched:d,alpha:h,maxVectorDistance:p,maxDistanceMode:m,directMatchWeight:x,onTotalCountChange:j}=e,[w,b]=(0,o.useState)(!1),k=(0,o.useRef)(null),[_,A]=(0,o.useState)(null),z=()=>{A(null),b(!1)},R=(0,r.jsx)(S,{variables:t,studyName:n,studyUuid:l,studyAncestors:i,query:a,variablesWhichMatched:d,alpha:h,maxVectorDistance:p,maxDistanceMode:m,directMatchWeight:x,onTotalCountChange:j,downloadAnchorEl:_,onDownloadClick:e=>{console.log("handleDownloadClick",e.currentTarget),A(k.current)},onDownloadClose:()=>{A(null)}});return w?(0,r.jsxs)(y.A,{ref:k,open:!0,onClose:z,maxWidth:"xl",fullWidth:!0,sx:{"& .MuiDialog-paper":{height:"90vh",maxHeight:"90vh"}},children:[(0,r.jsxs)(f.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pb:1},children:[(0,r.jsxs)(g.A,{variant:"h6",children:["Variables - ",n||"Study"]}),(0,r.jsx)(u.A,{onClick:z,size:"small",sx:{color:"text.secondary"},children:(0,r.jsx)(C,{size:20})})]}),(0,r.jsx)(v.A,{sx:{p:0,overflow:"hidden"},children:(0,r.jsx)(s.default,{sx:{height:"100%","& .MuiDataGrid-root":{borderRadius:0,maxHeight:"none",height:"100%"}},children:R})})]}):(0,r.jsxs)(s.default,{ref:k,sx:{position:"relative"},children:[(0,r.jsx)(s.default,{sx:{position:"absolute",top:8,right:8,zIndex:10,backgroundColor:"rgba(255, 255, 255, 0.9)",borderRadius:1},children:(0,r.jsx)(c.A,{title:"Open in large view",children:(0,r.jsx)(u.A,{size:"small",onClick:()=>{A(null),b(!0)},children:(0,r.jsx)(q,{size:20})})})}),(0,r.jsx)(s.default,{sx:{"& .MuiDataGrid-root":{height:450,borderRadius:2}},children:R})]})}n(8325)}}]);