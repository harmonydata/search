(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[897],{5225:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});let r=(0,n(14294).A)("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]])},8325:()=>{},20897:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>E});var r=n(95155),o=n(12115),l=n(50077),i=n(17231),a=n(38912),s=n(94049),u=n(78470),c=n(1151),d=n(88538),h=n(41602),p=n(23820),m=n(49501),x=n(17681),y=n(2778),f=n(52363),g=n(25635),v=n(65036),w=n(14294);let b=(0,w.A)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]),j=(0,w.A)("FileJson",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 12a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1 1 1 0 0 1 1 1v1a1 1 0 0 0 1 1",key:"1oajmo"}],["path",{d:"M14 18a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1 1 1 0 0 1-1-1v-1a1 1 0 0 0-1-1",key:"mpwhp6"}]]);var k=n(5225);let _=(0,w.A)("Table",[["path",{d:"M12 3v18",key:"108xh3"}],["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}]]),C=(0,w.A)("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),q=(0,w.A)("Maximize2",[["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["polyline",{points:"9 21 3 21 3 15",key:"1avn1i"}],["line",{x1:"21",x2:"14",y1:"3",y2:"10",key:"ota7mn"}],["line",{x1:"3",x2:"10",y1:"21",y2:"14",key:"1atl0r"}]]);var A=n(75183);let z=!1,S=null,R=async()=>{if(!z)return S||(S=new Promise((e,t)=>{if(customElements.get("harmony-export")){console.log("\uD83D\uDD0D Harmony export component already registered"),z=!0,S=null,e();return}console.log("\uD83D\uDD0D Loading harmony-export web component");let n=document.createElement("script");n.src="/app/js/harmony-export.js",n.async=!0,n.onload=()=>{console.log("✅ Harmony export component loaded successfully"),z=!0,S=null,e()},n.onerror=e=>{console.error("❌ Failed to load harmony-export component:",e),S=null,t(e)},document.head.appendChild(n)}))};function M(e){let{variables:t,studyName:n,studyUuid:y,studyAncestors:f,query:g,variablesWhichMatched:v,alpha:w,maxVectorDistance:C,maxDistanceMode:q,directMatchWeight:z,onTotalCountChange:S,onShouldHideTable:M,downloadAnchorEl:E,onDownloadClick:L,onDownloadClose:O}=e,T=(0,o.useRef)(null),D=(0,o.useRef)(null),[H,I]=(0,o.useState)(!1),[N,U]=(0,o.useState)(null),[F,X]=(0,o.useState)(!1),V=(0,o.useRef)(null),W=(0,o.useRef)(null),G=(0,o.useRef)(""),Q=(0,o.useRef)(null),B=(0,o.useMemo)(()=>{if(g&&g.trim().length>0)return{filter:{filterModel:{items:[],quickFilterValues:[g.trim()]}}}},[g]),J=(0,o.useMemo)(()=>{if(y)return{getRows:async e=>{var t,n;let r=(null==(n=e.filterModel)||null==(t=n.quickFilterValues)?void 0:t[0])||"",o=e.paginationModel||{page:0,pageSize:50},l=r!==G.current,i=!Q.current||o.page!==Q.current.page||o.pageSize!==Q.current.pageSize;if(G.current=r,Q.current=o,l&&!i)return V.current&&clearTimeout(V.current),W.current&&W.current.reject(Error("Request cancelled by new filter")),new Promise((e,t)=>{W.current={resolve:e,reject:t},V.current=setTimeout(async()=>{var e,t;try{let t=await a();null==(e=W.current)||e.resolve(t),W.current=null}catch(e){null==(t=W.current)||t.reject(e),W.current=null}},500)});return a();async function a(){let e={ancestor_uuid:y,query:r&&r.trim()?r.trim():void 0,num_results:o.pageSize,offset:o.page*o.pageSize,alpha:w,max_vector_distance:C,max_distance_mode:q,direct_match_weight:z};try{let t,n=await (0,A.CO)(e),l=n.results||[];if(0===l.length&&r&&r.trim()&&0===o.page&&o.pageSize>0){let t={...e,query:void 0};l=(n=await (0,A.CO)(t)).results||[],0===l.length&&(0===n.num_hits||void 0===n.num_hits)?(X(!0),null==M||M(!0)):(X(!1),null==M||M(!1))}else X(!1),null==M||M(!1);let i=new Set;v&&v.length>0&&v.forEach(e=>{e.name&&i.add(e.name)});let a=new Map;l.forEach(e=>{let t=e.name||"unnamed";a.set(t,(a.get(t)||0)+1)});let s=l.map((e,t)=>{let n=e.name||"unnamed",r=a.get(n)||1,l=o.page*o.pageSize,s="".concat(n,"-").concat(l,"-").concat(t),u=r>1?"".concat(n," (x").concat(r,")"):n,c=i.has(n);return{...e,id:s,originalIndex:t,displayName:u,repeatCount:r,matched:c}}),u=o.page*o.pageSize;return void 0!==n.num_hits&&null!==n.num_hits?(t=n.num_hits,0===u&&N!==n.num_hits&&(U(n.num_hits),null==S||S(n.num_hits))):t=s.length<o.pageSize?u+s.length:null!==N?N:-1,{rows:s,rowCount:t}}catch(e){return console.error("Failed to fetch variables:",e),{rows:[],rowCount:0}}}}}},[y,w,C,q,z,v]);(0,o.useEffect)(()=>()=>{V.current&&clearTimeout(V.current),W.current&&W.current.reject(Error("Component unmounted"))},[]),(0,o.useEffect)(()=>{U(null),null==S||S(null)},[y,g,S]);let P=y?[]:t||[];(0,o.useEffect)(()=>{R().catch(e=>{console.error("Failed to load harmony-export component:",e)})},[]);let Z=(0,o.useCallback)((e,t)=>{let n=e.question&&e.question.trim().length>0,r=e.description&&e.description.trim().length>0,o=e.name&&e.name.trim().length>0,l=(n||r)&&o?e.name:t,i="";i=n&&r?e.question.trim()===e.description.trim()?e.question:"".concat(e.question," [").concat(e.description,"]"):n?e.question:r?e.description:o?e.name:"";let a=e.response_options||e.options;return{question_no:l,question_text:i,response_options:a&&Array.isArray(a)?a.join(" / "):""}},[]),K=[{field:"question_no",headerName:"Code",width:120,valueGetter:(e,t)=>{var n;return Z(t,null!=(n=t.originalIndex)?n:0).question_no},sortable:!0},{field:"description",headerName:"Question / Variable name",flex:2,valueGetter:(e,t)=>{var n,r;return t.displayName&&t.repeatCount>1?Z(t,null!=(n=t.originalIndex)?n:0).question_text||t.displayName:Z(t,null!=(r=t.originalIndex)?r:0).question_text},sortable:!0},{field:"options",headerName:"Response Options",flex:1,valueGetter:(e,t)=>{var n;return Z(t,null!=(n=t.originalIndex)?n:0).response_options},sortable:!0}],Y=P.filter(e=>e.name||e.description).map((e,t)=>({id:e.name||t,originalIndex:t,...e})),$=o.useRef(null);(0,o.useEffect)(()=>{let e=setTimeout(()=>{$.current&&I(!0)},200);return()=>clearTimeout(e)},[$]);let ee=()=>{let e=$.current;if(!e||!H)return[];try{let t=e.getSelectedRows();return t?Array.from(t.values()):[]}catch(e){return console.warn("Failed to get selected items:",e),[]}},et=(0,o.useCallback)(()=>{if(!T.current||!H)return;let e=ee();if(T.current.innerHTML="",0===e.length)return;console.log("selectedItems:",e);let t=e.map(e=>{var t;let n=Z(e,null!=(t=e.originalIndex)?t:0);return{question_no:n.question_no,question_text:n.question_text}}),r=document.createElement("harmony-export");r.size="32px",r.instrument_name="".concat(n||"Selected Variables"," from harmonydata.ac.uk/discover"),r.questions=t,T.current.appendChild(r)},[H,n]);(0,o.useEffect)(()=>{if(!H||!$.current)return;let e=$.current.subscribeEvent("rowSelectionChange",()=>{et()});return()=>{e()}},[H,et]);let en=()=>{null==O||O()},er=()=>{let e,t=$.current;if(!t||!H)return[];try{e=t.getSelectedRows()}catch(t){e=null}return(e&&"number"==typeof e.size&&e.size>0&&e?Array.from(e.values()):(()=>{let e;try{e=t.getRowModels()}catch(t){e=null}return e?Array.from(e.values()):[]})()).map(e=>{var t;let n=Z(e,null!=(t=e.originalIndex)?t:0);return{question_no:n.question_no,question_text:n.question_text,response_options:n.response_options}})},eo=async()=>{let e=er();await new Promise((e,t)=>{if(window.XLSX)return void e();let n=document.querySelector('script[src="/js/xlsx.min.js"]');if(n){n.addEventListener("load",()=>e()),n.addEventListener("error",t);return}let r=document.createElement("script");r.src="/js/xlsx.min.js",r.async=!0,r.onload=()=>e(),r.onerror=t,document.head.appendChild(r)});let t=window.XLSX||globalThis.XLSX;if(!t){console.error("XLSX library failed to load"),en();return}let n=t.utils.json_to_sheet(e),r=t.utils.book_new();t.utils.book_append_sheet(r,n,"Questions");let o=new Blob([t.write(r,{bookType:"xlsx",type:"array"})],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),l=URL.createObjectURL(o),i=document.createElement("a");i.href=l,i.download="questions.xlsx",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(l),en()};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.default,{sx:{height:"100%",minHeight:400},children:(Y.length>0||J)&&(0,r.jsx)(l.z,{apiRef:$,...J?{dataSource:J}:{rows:Y},columns:K,checkboxSelection:!0,sortModel:[{field:"score",sort:"desc"}],getRowClassName:e=>e.row.matched?"matched-row":"",filterMode:y?"server":"client",sortingMode:y?"server":"client",paginationMode:y?"server":"client",sx:{background:"white",borderRadius:2,fontSize:14,height:"100%","& .matched-row":{backgroundColor:"#fffae4","&:hover":{backgroundColor:"#fff8d1"}}},hideFooter:!y,pageSizeOptions:[20,50,100],pagination:!0,showToolbar:!0,initialState:B,slots:{toolbar:()=>(0,r.jsxs)(s.default,{sx:{display:"flex",alignItems:"center",gap:2,p:1,mr:2,flexWrap:"wrap"},children:[(0,r.jsx)(s.default,{sx:{flex:1,minWidth:200},children:(0,r.jsx)(i.e,{expanded:!0,style:{width:"100%"},children:(0,r.jsx)(a.X,{placeholder:"Search within variables",style:{background:"white",borderRadius:192,fontSize:14}})})}),(0,r.jsx)(u.A,{title:"Harmonise selected items",children:(0,r.jsx)(c.A,{size:"small",sx:{width:40,height:40},children:(0,r.jsx)(s.default,{ref:T,sx:{display:"flex",alignItems:"center",justifyContent:"center",width:20,height:20}})})}),(0,r.jsx)(u.A,{title:(()=>{let e=$.current;if(!e||!H)return!1;try{let t=e.getSelectedRows();return t&&"number"==typeof t.size&&t.size>0}catch(e){return!1}})()?"Download ".concat(ee().length," selected questions"):"Download all questions",children:(0,r.jsx)(c.A,{ref:D,size:"small",onClick:L,sx:{width:40,height:40},children:(0,r.jsx)(b,{size:30})})})]})}})}),(0,r.jsx)(d.Ay,{open:!!E,anchorEl:E,onClose:en,anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"center"},children:(0,r.jsxs)(h.A,{sx:{width:200},children:[(0,r.jsxs)(p.Ay,{onClick:()=>{let e=new Blob([JSON.stringify(er(),null,2)],{type:"application/json"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="questions.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),en()},sx:{cursor:"pointer"},children:[(0,r.jsx)(m.A,{children:(0,r.jsx)(j,{size:20})}),(0,r.jsx)(x.A,{primary:"Download as JSON"})]}),(0,r.jsxs)(p.Ay,{onClick:()=>{let e=new Blob([[["Question Number","Question Text","Response Options"],...er().map(e=>[e.question_no,e.question_text,e.response_options])].map(e=>e.map(e=>'"'.concat(e,'"')).join(",")).join("\n")],{type:"text/csv"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="questions.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),en()},sx:{cursor:"pointer"},children:[(0,r.jsx)(m.A,{children:(0,r.jsx)(k.A,{size:20})}),(0,r.jsx)(x.A,{primary:"Download as CSV"})]}),(0,r.jsxs)(p.Ay,{onClick:eo,sx:{cursor:"pointer"},children:[(0,r.jsx)(m.A,{children:(0,r.jsx)(_,{size:20})}),(0,r.jsx)(x.A,{primary:"Download as Excel"})]})]})})]})}function E(e){let{variables:t,studyName:n,studyUuid:l,studyAncestors:i,query:a,variablesWhichMatched:d,alpha:h,maxVectorDistance:p,maxDistanceMode:m,directMatchWeight:x,onTotalCountChange:w,onShouldHideTable:b}=e,[j,k]=(0,o.useState)(!1),_=(0,o.useRef)(null),[A,z]=(0,o.useState)(null),S=()=>{z(null),k(!1)},R=(0,r.jsx)(M,{variables:t,studyName:n,studyUuid:l,studyAncestors:i,query:a,variablesWhichMatched:d,alpha:h,maxVectorDistance:p,maxDistanceMode:m,directMatchWeight:x,onTotalCountChange:w,onShouldHideTable:b,downloadAnchorEl:A,onDownloadClick:e=>{console.log("handleDownloadClick",e.currentTarget),z(_.current)},onDownloadClose:()=>{z(null)}});return j?(0,r.jsxs)(y.A,{ref:_,open:!0,onClose:S,maxWidth:"xl",fullWidth:!0,sx:{"& .MuiDialog-paper":{height:"90vh",maxHeight:"90vh"}},children:[(0,r.jsxs)(f.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pb:1},children:[(0,r.jsxs)(g.A,{variant:"h6",children:["Variables - ",n||"Study"]}),(0,r.jsx)(c.A,{onClick:S,size:"small",sx:{color:"text.secondary"},children:(0,r.jsx)(C,{size:20})})]}),(0,r.jsx)(v.A,{sx:{p:0,overflow:"hidden"},children:(0,r.jsx)(s.default,{sx:{height:"100%","& .MuiDataGrid-root":{borderRadius:0,maxHeight:"none",height:"100%"}},children:R})})]}):(0,r.jsxs)(s.default,{ref:_,sx:{position:"relative"},children:[(0,r.jsx)(s.default,{sx:{position:"absolute",top:8,right:8,zIndex:10,backgroundColor:"rgba(255, 255, 255, 0.9)",borderRadius:1},children:(0,r.jsx)(u.A,{title:"Open in large view",children:(0,r.jsx)(c.A,{size:"small",onClick:()=>{z(null),k(!0)},children:(0,r.jsx)(q,{size:20})})})}),(0,r.jsx)(s.default,{sx:{"& .MuiDataGrid-root":{height:450,borderRadius:2}},children:R})]})}n(8325)}}]);