(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[897],{5225:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});let o=(0,n(14294).A)("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]])},8325:()=>{},20897:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>S});var o=n(95155),r=n(12115),l=n(50077),i=n(17231),s=n(38912),a=n(94049),d=n(78470),c=n(1151),u=n(88538),h=n(41602),p=n(23820),x=n(49501),m=n(17681),y=n(2778),f=n(52363),g=n(25635),j=n(65036),b=n(14294);let w=(0,b.A)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]),v=(0,b.A)("FileJson",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 12a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1 1 1 0 0 1 1 1v1a1 1 0 0 0 1 1",key:"1oajmo"}],["path",{d:"M14 18a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1 1 1 0 0 1-1-1v-1a1 1 0 0 0-1-1",key:"mpwhp6"}]]);var k=n(5225);let A=(0,b.A)("Table",[["path",{d:"M12 3v18",key:"108xh3"}],["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}]]),C=(0,b.A)("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),q=(0,b.A)("Maximize2",[["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["polyline",{points:"9 21 3 21 3 15",key:"1avn1i"}],["line",{x1:"21",x2:"14",y1:"3",y2:"10",key:"ota7mn"}],["line",{x1:"3",x2:"10",y1:"21",y2:"14",key:"1atl0r"}]]),R=!1,_=null,z=async()=>{if(!R)return _||(_=new Promise((e,t)=>{if(customElements.get("harmony-export")){console.log("\uD83D\uDD0D Harmony export component already registered"),R=!0,_=null,e();return}console.log("\uD83D\uDD0D Loading harmony-export web component");let n=document.createElement("script");n.src="/app/js/harmony-export.js",n.async=!0,n.onload=()=>{console.log("✅ Harmony export component loaded successfully"),R=!0,_=null,e()},n.onerror=e=>{console.error("❌ Failed to load harmony-export component:",e),_=null,t(e)},document.head.appendChild(n)}))};function M(e){let{variables:t,studyName:n,downloadAnchorEl:y,onDownloadClick:f,onDownloadClose:g}=e,j=(0,r.useRef)(null),b=(0,r.useRef)(null),[C,q]=(0,r.useState)(!1);(0,r.useEffect)(()=>{z().catch(e=>{console.error("Failed to load harmony-export component:",e)})},[]);let R=(e,t)=>{let n=e.question&&e.question.trim().length>0,o=e.description&&e.description.trim().length>0,r=e.name&&e.name.trim().length>0,l=(n||o)&&r?e.name:t,i="";i=n&&o?e.question.trim()===e.description.trim()?e.question:"".concat(e.question," [").concat(e.description,"]"):n?e.question:o?e.description:r?e.name:"";let s=e.response_options||e.options;return{question_no:l,question_text:i,response_options:s&&Array.isArray(s)?s.join(" / "):""}},_=[{field:"question_no",headerName:"Code",width:120,valueGetter:(e,t)=>{var n;return R(t,null!=(n=t.originalIndex)?n:0).question_no},sortable:!0},{field:"description",headerName:"Question / Variable name",flex:2,valueGetter:(e,t)=>{var n;return R(t,null!=(n=t.originalIndex)?n:0).question_text},sortable:!0},{field:"options",headerName:"Response Options",flex:1,valueGetter:(e,t)=>{var n;return R(t,null!=(n=t.originalIndex)?n:0).response_options},sortable:!0}],M=t.filter(e=>e.name||e.description).map((e,t)=>({id:e.name||t,originalIndex:t,...e})),S=r.useRef(null);(0,r.useEffect)(()=>{let e=setTimeout(()=>{S.current&&q(!0)},200);return()=>clearTimeout(e)},[S]);let L=()=>{let e=S.current;if(!e||!C)return[];try{let t=e.getSelectedRows();return t?Array.from(t.values()):[]}catch(e){return console.warn("Failed to get selected items:",e),[]}},E=(0,r.useCallback)(()=>{if(!j.current||!C)return;let e=L();if(j.current.innerHTML="",0===e.length)return;console.log("selectedItems:",e);let t=e.map(e=>{var t;let n=R(e,null!=(t=e.originalIndex)?t:0);return{question_no:n.question_no,question_text:n.question_text}}),o=document.createElement("harmony-export");o.size="32px",o.instrument_name="".concat(n||"Selected Variables"," from harmonydata.ac.uk/discover"),o.questions=t,j.current.appendChild(o)},[C,n]);(0,r.useEffect)(()=>{if(!C||!S.current)return;let e=S.current.subscribeEvent("rowSelectionChange",()=>{E()});return()=>{e()}},[C,E]);let O=()=>{null==g||g()},H=()=>{let e,t=S.current;if(!t||!C)return[];try{e=t.getSelectedRows()}catch(t){e=null}return(e&&"number"==typeof e.size&&e.size>0&&e?Array.from(e.values()):(()=>{let e;try{e=t.getRowModels()}catch(t){e=null}return e?Array.from(e.values()):[]})()).map(e=>{var t;let n=R(e,null!=(t=e.originalIndex)?t:0);return{question_no:n.question_no,question_text:n.question_text,response_options:n.response_options}})},D=async()=>{let e=H();await new Promise((e,t)=>{if(window.XLSX)return void e();let n=document.querySelector('script[src="/js/xlsx.min.js"]');if(n){n.addEventListener("load",()=>e()),n.addEventListener("error",t);return}let o=document.createElement("script");o.src="/js/xlsx.min.js",o.async=!0,o.onload=()=>e(),o.onerror=t,document.head.appendChild(o)});let t=window.XLSX||globalThis.XLSX;if(!t){console.error("XLSX library failed to load"),O();return}let n=t.utils.json_to_sheet(e),o=t.utils.book_new();t.utils.book_append_sheet(o,n,"Questions");let r=new Blob([t.write(o,{bookType:"xlsx",type:"array"})],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),l=URL.createObjectURL(r),i=document.createElement("a");i.href=l,i.download="questions.xlsx",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(l),O()};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(a.default,{sx:{height:"100%",minHeight:400},children:M.length>0&&(0,o.jsx)(l.z,{apiRef:S,paginationMode:"server",rowCount:M.length,rows:M,columns:_,checkboxSelection:!0,sortModel:[{field:"score",sort:"desc"}],getRowClassName:e=>e.row.matched?"matched-row":"",sx:{background:"white",borderRadius:2,fontSize:14,height:"100%","& .matched-row":{backgroundColor:"#fffae4","&:hover":{backgroundColor:"#fff8d1"}}},hideFooter:!0,pageSizeOptions:[20,50,100],showToolbar:!0,slots:{toolbar:()=>(0,o.jsxs)(a.default,{sx:{display:"flex",alignItems:"center",gap:2,p:1,mr:2},children:[(0,o.jsx)(i.e,{expanded:!0,style:{width:"100%"},children:(0,o.jsx)(s.X,{placeholder:"Search within variables",style:{background:"white",borderRadius:192,fontSize:14,margin:15,width:"calc(100% - 15px)",height:"auto"}})}),(0,o.jsx)(d.A,{title:"Harmonise selected items",children:(0,o.jsx)(c.A,{size:"small",sx:{width:40,height:40},children:(0,o.jsx)(a.default,{ref:j,sx:{display:"flex",alignItems:"center",justifyContent:"center",width:20,height:20}})})}),(0,o.jsx)(d.A,{title:(()=>{let e=S.current;if(!e||!C)return!1;try{let t=e.getSelectedRows();return t&&"number"==typeof t.size&&t.size>0}catch(e){return!1}})()?"Download ".concat(L().length," selected questions"):"Download all questions",children:(0,o.jsx)(c.A,{ref:b,size:"small",onClick:f,sx:{width:40,height:40},children:(0,o.jsx)(w,{size:30})})})]})}})}),(0,o.jsx)(u.Ay,{open:!!y,anchorEl:y,onClose:O,anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"center"},children:(0,o.jsxs)(h.A,{sx:{width:200},children:[(0,o.jsxs)(p.Ay,{onClick:()=>{let e=new Blob([JSON.stringify(H(),null,2)],{type:"application/json"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="questions.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),O()},sx:{cursor:"pointer"},children:[(0,o.jsx)(x.A,{children:(0,o.jsx)(v,{size:20})}),(0,o.jsx)(m.A,{primary:"Download as JSON"})]}),(0,o.jsxs)(p.Ay,{onClick:()=>{let e=new Blob([[["Question Number","Question Text","Response Options"],...H().map(e=>[e.question_no,e.question_text,e.response_options])].map(e=>e.map(e=>'"'.concat(e,'"')).join(",")).join("\n")],{type:"text/csv"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="questions.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),O()},sx:{cursor:"pointer"},children:[(0,o.jsx)(x.A,{children:(0,o.jsx)(k.A,{size:20})}),(0,o.jsx)(m.A,{primary:"Download as CSV"})]}),(0,o.jsxs)(p.Ay,{onClick:D,sx:{cursor:"pointer"},children:[(0,o.jsx)(x.A,{children:(0,o.jsx)(A,{size:20})}),(0,o.jsx)(m.A,{primary:"Download as Excel"})]})]})})]})}function S(e){let{variables:t,studyName:n}=e,[l,i]=(0,r.useState)(!1),s=(0,r.useRef)(null),[u,h]=(0,r.useState)(null),p=()=>{h(null),i(!1)},x=(0,o.jsx)(M,{variables:t,studyName:n,downloadAnchorEl:u,onDownloadClick:e=>{console.log("handleDownloadClick",e.currentTarget),h(s.current)},onDownloadClose:()=>{h(null)}});return l?(0,o.jsxs)(y.A,{ref:s,open:!0,onClose:p,maxWidth:"xl",fullWidth:!0,sx:{"& .MuiDialog-paper":{height:"90vh",maxHeight:"90vh"}},children:[(0,o.jsxs)(f.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pb:1},children:[(0,o.jsxs)(g.A,{variant:"h6",children:["Variables - ",n||"Study"]}),(0,o.jsx)(c.A,{onClick:p,size:"small",sx:{color:"text.secondary"},children:(0,o.jsx)(C,{size:20})})]}),(0,o.jsx)(j.A,{sx:{p:0,overflow:"hidden"},children:(0,o.jsx)(a.default,{sx:{height:"100%","& .MuiDataGrid-root":{borderRadius:0,maxHeight:"none",height:"100%"}},children:x})})]}):(0,o.jsxs)(a.default,{ref:s,sx:{position:"relative"},children:[(0,o.jsx)(a.default,{sx:{position:"absolute",top:8,right:8,zIndex:10,backgroundColor:"rgba(255, 255, 255, 0.9)",borderRadius:1},children:(0,o.jsx)(d.A,{title:"Open in large view",children:(0,o.jsx)(c.A,{size:"small",onClick:()=>{h(null),i(!0)},children:(0,o.jsx)(q,{size:20})})})}),(0,o.jsx)(a.default,{sx:{"& .MuiDataGrid-root":{height:450,borderRadius:2}},children:x})]})}n(8325)}}]);